<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>40-æ¡ˆä¾‹åˆ†æï¼ˆä¸‰ï¼‰ï¼šé«˜æ€§èƒ½é˜Ÿåˆ—Disruptor</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
        <style>
        html {
            color: #333;
            -webkit-text-size-adjust: 100%;
            -ms-text-size-adjust: 100%;
            text-rendering: optimizelegibility;
            font-family: Helvetica Neue, PingFang SC, Verdana, Microsoft Yahei, Hiragino Sans GB, Microsoft Sans Serif, WenQuanYi Micro Hei, sans-serif
        }

        html.borderbox *,
        html.borderbox :after,
        html.borderbox :before {
            box-sizing: border-box
        }

        article,
        aside,
        blockquote,
        body,
        button,
        code,
        dd,
        details,
        dl,
        dt,
        fieldset,
        figcaption,
        figure,
        footer,
        form,
        h1,
        h2,
        h3,
        h4,
        h5,
        h6,
        header,
        hr,
        input,
        legend,
        li,
        menu,
        nav,
        ol,
        p,
        pre,
        section,
        td,
        textarea,
        th,
        ul {
            margin: 0;
            padding: 0
        }

        article,
        aside,
        details,
        figcaption,
        figure,
        footer,
        header,
        menu,
        nav,
        section {
            display: block
        }

        audio,
        canvas,
        video {
            display: inline-block
        }

        body,
        button,
        input,
        select,
        textarea {
            font: 300 1em/1.8 PingFang SC, Lantinghei SC, Microsoft Yahei, Hiragino Sans GB, Microsoft Sans Serif, WenQuanYi Micro Hei, Helvetica, sans-serif
        }

        button::-moz-focus-inner,
        input::-moz-focus-inner {
            padding: 0;
            border: 0
        }

        table {
            border-collapse: collapse;
            border-spacing: 0
        }

        fieldset,
        img {
            border: 0
        }

        blockquote {
            position: relative;
            color: #999;
            font-weight: 400;
            border-left: 1px solid #1abc9c;
            padding-left: 1em;
            margin: 1em 3em 1em 2em
        }

        @media only screen and (max-width: 640px) {
            blockquote {
                margin: 1em 0
            }
        }

        abbr,
        acronym {
            border-bottom: 1px dotted;
            font-variant: normal
        }

        abbr {
            cursor: help
        }

        del {
            text-decoration: line-through
        }

        address,
        caption,
        cite,
        code,
        dfn,
        em,
        th,
        var {
            font-style: normal;
            font-weight: 400
        }

        ol,
        ul {
            list-style: none
        }

        caption,
        th {
            text-align: left
        }

        q:after,
        q:before {
            content: ""
        }

        sub,
        sup {
            font-size: 75%;
            line-height: 0;
            position: relative
        }

        :root sub,
        :root sup {
            vertical-align: baseline
        }

        sup {
            top: -.5em
        }

        sub {
            bottom: -.25em
        }

        a {
            color: #1abc9c
        }

        a:hover {
            text-decoration: underline
        }

        .typo a {
            border-bottom: 1px solid #1abc9c
        }

        .typo a:hover {
            border-bottom-color: #555;
            color: #555
        }

        .typo a:hover,
        a,
        ins {
            text-decoration: none
        }

        .typo-u,
        u {
            text-decoration: underline
        }

        mark {
            background: #fffdd1;
            border-bottom: 1px solid #ffedce;
            padding: 2px;
            margin: 0 5px
        }

        code,
        pre,
        pre tt {
            font-family: Courier, Courier New, monospace
        }

        pre {
            background: hsla(0, 0%, 97%, .7);
            border: 1px solid #ddd;
            padding: 1em 1.5em;
            display: block;
            -webkit-overflow-scrolling: touch
        }

        hr {
            border: none;
            border-bottom: 1px solid #cfcfcf;
            margin-bottom: .8em;
            height: 10px
        }

        .typo-small,
        figcaption,
        small {
            font-size: .9em;
            color: #888
        }

        b,
        strong {
            font-weight: 700;
            color: #000
        }

        [draggable] {
            cursor: move
        }

        .clearfix:after,
        .clearfix:before {
            content: "";
            display: table
        }

        .clearfix:after {
            clear: both
        }

        .clearfix {
            zoom: 1
        }

        .textwrap,
        .textwrap td,
        .textwrap th {
            word-wrap: break-word;
            word-break: break-all
        }

        .textwrap-table {
            table-layout: fixed
        }

        .serif {
            font-family: Palatino, Optima, Georgia, serif
        }

        .typo-dl,
        .typo-form,
        .typo-hr,
        .typo-ol,
        .typo-p,
        .typo-pre,
        .typo-table,
        .typo-ul,
        .typo dl,
        .typo form,
        .typo hr,
        .typo ol,
        .typo p,
        .typo pre,
        .typo table,
        .typo ul,
        blockquote {
            margin-bottom: 1rem
        }

        h1,
        h2,
        h3,
        h4,
        h5,
        h6 {
            font-family: PingFang SC, Helvetica Neue, Verdana, Microsoft Yahei, Hiragino Sans GB, Microsoft Sans Serif, WenQuanYi Micro Hei, sans-serif;
            color: #000;
            line-height: 1.35
        }

        .typo-h1,
        .typo-h2,
        .typo-h3,
        .typo-h4,
        .typo-h5,
        .typo-h6,
        .typo h1,
        .typo h2,
        .typo h3,
        .typo h4,
        .typo h5,
        .typo h6 {
            margin-top: 1.2em;
            margin-bottom: .6em;
            line-height: 1.35
        }

        .typo-h1,
        .typo h1 {
            font-size: 2em
        }

        .typo-h2,
        .typo h2 {
            font-size: 1.8em
        }

        .typo-h3,
        .typo h3 {
            font-size: 1.6em
        }

        .typo-h4,
        .typo h4 {
            font-size: 1.4em
        }

        .typo-h5,
        .typo-h6,
        .typo h5,
        .typo h6 {
            font-size: 1.2em
        }

        .typo-ul,
        .typo ul {
            margin-left: 1.3em;
            list-style: disc
        }

        .typo-ol,
        .typo ol {
            list-style: decimal;
            margin-left: 1.9em
        }

        .typo-ol ol,
        .typo-ol ul,
        .typo-ul ol,
        .typo-ul ul,
        .typo li ol,
        .typo li ul {
            margin-bottom: .8em;
            margin-left: 2em
        }

        .typo-ol ul,
        .typo-ul ul,
        .typo li ul {
            list-style: circle
        }

        .typo-table td,
        .typo-table th,
        .typo table caption,
        .typo table td,
        .typo table th {
            border: 1px solid #ddd;
            padding: .5em 1em;
            color: #666
        }

        .typo-table th,
        .typo table th {
            background: #fbfbfb
        }

        .typo-table thead th,
        .typo table thead th {
            background: hsla(0, 0%, 95%, .7)
        }

        .typo table caption {
            border-bottom: none
        }

        .typo-input,
        .typo-textarea {
            -webkit-appearance: none;
            border-radius: 0
        }

        .typo-em,
        .typo em,
        caption,
        legend {
            color: #000;
            font-weight: inherit
        }

        .typo-em {
            position: relative
        }

        .typo-em:after {
            position: absolute;
            top: .65em;
            left: 0;
            width: 100%;
            overflow: hidden;
            white-space: nowrap;
            content: "\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB"
        }

        .typo img {
            max-width: 100%
        }

        .common-content {
            font-weight: 400;
            color: #353535;
            line-height: 1.75rem;
            white-space: normal;
            word-break: normal;
            font-size: 1rem
        }

        .common-content img {
            display: block;
            max-width: 100%;
            background-color: #eee
        }

        .common-content audio,
        .common-content video {
            width: 100%;
            background-color: #eee
        }

        .common-content center,
        .common-content font {
            margin-top: 1rem;
            display: inline-block
        }

        .common-content center {
            width: 100%
        }

        .common-content pre {
            margin-top: 1rem;
            padding-left: 0;
            padding-right: 0;
            position: relative;
            overflow: hidden
        }

        .common-content pre code {
            font-size: .8rem;
            font-family: Consolas, Liberation Mono, Menlo, monospace, Courier;
            display: block;
            width: 100%;
            box-sizing: border-box;
            padding-left: 1rem;
            padding-right: 1rem;
            overflow-x: auto
        }

        .common-content hr {
            border: none;
            margin-top: 1.5rem;
            margin-bottom: 1.5rem;
            border-top: 1px solid #f5f5f5;
            height: 1px;
            background: none
        }

        .common-content b,
        .common-content h1,
        .common-content h2,
        .common-content h3,
        .common-content h4,
        .common-content h5,
        .common-content strong {
            font-weight: 700
        }

        .common-content h1,
        .common-content h2 {
            font-size: 1.125rem;
            margin-bottom: .45rem
        }

        .common-content h3,
        .common-content h4,
        .common-content h5 {
            font-size: 1rem;
            margin-bottom: .45rem
        }

        .common-content p {
            font-weight: 400;
            color: #353535;
            margin-top: .15rem
        }

        .common-content .orange {
            color: #ff5a05
        }

        .common-content .reference {
            font-size: 1rem;
            color: #888
        }

        .custom-rich-content h1 {
            margin-top: 0;
            font-weight: 400;
            font-size: 15.25px;
            border-bottom: 1px solid #eee;
            line-height: 2.8
        }

        .custom-rich-content li,
        .custom-rich-content p {
            font-size: 14px;
            color: #888;
            line-height: 1.6
        }

        table.hljs-ln {
            margin-bottom: 0;
            border-spacing: 0;
            border-collapse: collapse
        }

        table.hljs-ln,
        table.hljs-ln tbody,
        table.hljs-ln td,
        table.hljs-ln tr {
            box-sizing: border-box
        }

        table.hljs-ln td {
            padding: 0;
            border: 0
        }

        table.hljs-ln td.hljs-ln-numbers {
            min-width: 15px;
            color: rgba(27, 31, 35, .3);
            text-align: right;
            white-space: nowrap;
            cursor: pointer;
            user-select: none
        }

        table.hljs-ln td.hljs-ln-code,
        table.hljs-ln td.hljs-ln-numbers {
            font-family: SFMono-Regular, Consolas, Liberation Mono, Menlo, Courier, monospace;
            font-size: 12px;
            line-height: 20px;
            vertical-align: top
        }

        table.hljs-ln td.hljs-ln-code {
            position: relative;
            padding-right: 10px;
            padding-left: 10px;
            overflow: visible;
            color: #24292e;
            word-wrap: normal;
            white-space: pre
        }

        video::-webkit-media-controls {
            overflow: hidden !important
        }

        video::-webkit-media-controls-enclosure {
            width: calc(100% + 32px);
            margin-left: auto
        }

        ._29HP61GA_0 {
            max-width:800px;
            margin:0 auto;
            margin-bottom: 20px;
            font-weight: 400;
            color: #353535;
            line-height: 1.76;
            white-space: normal;
            word-break: normal;
            font-size: 17px;
            -webkit-transition: background-color .3s ease;
            transition: background-color .3s ease
        }

        ._29HP61GA_0 .MathJax_Display {
            overflow: auto
        }

        ._29HP61GA_0 .poster {
            position: fixed;
            left: -10000px;
            top: -10000px;
            overflow: hidden;
            padding: 1rem;
            background: #ececec
        }

        ._29HP61GA_0 .richcontent-pre-copy {
            font-size: 13px;
            color: #888;
            position: absolute;
            right: 1em;
            top: .5em;
            cursor: pointer;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none
        }

        ._29HP61GA_0 .richcontent-pre-copy .iconfont {
            font-size: 12px;
            margin-right: .2em
        }

        ._29HP61GA_0 a {
            color: #fa8919;
            border-bottom: 1px solid #fa8919
        }

        ._29HP61GA_0 img {
            display: block;
            max-width: 100%;
            position: relative;
            left: 50%;
            -webkit-transform: translateX(-50%);
            transform: translateX(-50%);
            background-color: #eee;
            vertical-align: top;
            border-radius: 0
        }

        ._29HP61GA_0 audio,
        ._29HP61GA_0 video {
            width: 100%;
            background-color: #eee
        }

        ._29HP61GA_0 pre {
            margin-top: 16px;
            padding: 34px 0 0;
            margin-bottom: 30px;
            position: relative;
            border-radius: 6px;
            background: rgba(246, 247, 251, .749);
            border: 0
        }

        ._29HP61GA_0 pre code {
            font-size: 12px;
            font-family: Consolas, Liberation Mono, Menlo, monospace, Courier;
            display: block;
            -webkit-box-sizing: border-box;
            box-sizing: border-box;
            margin-left: 16px;
            margin-right: 16px;
            overflow-x: scroll
        }

        ._29HP61GA_0 pre code:after {
            content: "";
            height: 30px;
            width: 100%;
            display: block
        }

        ._29HP61GA_0 hr {
            border: none;
            margin-top: 1.5rem;
            margin-bottom: 1.5rem;
            border-top: 1px solid #f5f5f5;
            height: 1px;
            background: none
        }

        ._29HP61GA_0 h1,
        ._29HP61GA_0 h2,
        ._29HP61GA_0 h3,
        ._29HP61GA_0 h4,
        ._29HP61GA_0 h5 {
            margin-bottom: 20px;
            margin-top: 0;
            font-weight: 700
        }

        ._29HP61GA_0 b,
        ._29HP61GA_0 strong {
            font-weight: 700
        }

        ._29HP61GA_0 h1 {
            font-size: 21px
        }

        ._29HP61GA_0 h2 {
            font-size: 20px
        }

        ._29HP61GA_0 h3 {
            font-size: 19px
        }

        ._29HP61GA_0 h4 {
            font-size: 18px
        }

        ._29HP61GA_0 h5 {
            font-size: 17px
        }

        ._29HP61GA_0 center,
        ._29HP61GA_0 p {
            font-weight: 400;
            color: #353535;
            margin-top: 0;
            margin-bottom: 30px;
            word-break: break-word
        }

        ._29HP61GA_0 center {
            text-align: center
        }

        ._29HP61GA_0 blockquote {
            margin-top: 0;
            margin-bottom: 34px;
            border-left: 3px solid #e8e8e8;
            padding-left: 17px;
            color: #353535
        }

        ._29HP61GA_0 blockquote p {
            margin-top: 0;
            margin-bottom: 0
        }

        ._29HP61GA_0 ol,
        ._29HP61GA_0 ul {
            margin-bottom: 30px
        }

        ._29HP61GA_0 ol p,
        ._29HP61GA_0 ul p {
            margin-top: 0;
            margin-bottom: 0
        }

        ._29HP61GA_0 ol {
            list-style: decimal;
            margin-left: 20px
        }

        ._29HP61GA_0 ul li {
            padding-left: 17px;
            position: relative;
            margin-bottom: 10px
        }

        ._29HP61GA_0 ul li:after {
            content: "";
            height: 6px;
            width: 6px;
            border-radius: 50%;
            background: #353535;
            position: absolute;
            top: 10px;
            left: 0
        }

        ._29HP61GA_0 .orange {
            color: #fa8919
        }

        ._29HP61GA_0 .reference {
            color: #888
        }

        ._29HP61GA_0 .m-right {
            text-align: right
        }

        ._29HP61GA_0 .m-center {
            text-align: center;
            display: block
        }

        ._29HP61GA_0 .m-gray {
            color: #888
        }

        ._29HP61GA_0 .m-small {
            font-size: 15px
        }

        ._29HP61GA_0 table.hljs-ln {
            margin-bottom: 0;
            border-spacing: 0;
            border-collapse: collapse
        }

        ._29HP61GA_0 table.hljs-ln,
        ._29HP61GA_0 table.hljs-ln tbody,
        ._29HP61GA_0 table.hljs-ln td,
        ._29HP61GA_0 table.hljs-ln tr {
            -webkit-box-sizing: border-box;
            box-sizing: border-box
        }

        ._29HP61GA_0 table.hljs-ln td {
            padding: 0;
            border: 0
        }

        ._29HP61GA_0 table.hljs-ln td.hljs-ln-numbers {
            min-width: 15px;
            font-size: 12px;
            color: rgba(27, 31, 35, .3);
            text-align: right;
            white-space: nowrap;
            cursor: pointer;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none
        }

        ._29HP61GA_0 table.hljs-ln td.hljs-ln-code,
        ._29HP61GA_0 table.hljs-ln td.hljs-ln-numbers {
            font-family: SFMono-Regular, Consolas, Liberation Mono, Menlo, Courier, monospace;
            line-height: 20px;
            vertical-align: top
        }

        ._29HP61GA_0 table.hljs-ln td.hljs-ln-code {
            position: relative;
            padding-right: 10px;
            padding-left: 10px;
            overflow: visible;
            font-size: 13px;
            color: #666;
            word-wrap: normal;
            white-space: pre
        }

    </style>
</head>
<body>
<div class="_29HP61GA_0">
<h1>40-æ¡ˆä¾‹åˆ†æï¼ˆä¸‰ï¼‰ï¼šé«˜æ€§èƒ½é˜Ÿåˆ—Disruptor</h1>
<p>æˆ‘ä»¬åœ¨<a href="https://time.geekbang.org/column/article/90201">ã€Š20 | å¹¶å‘å®¹å™¨ï¼šéƒ½æœ‰å“ªäº›â€œå‘â€éœ€è¦æˆ‘ä»¬å¡«ï¼Ÿã€‹</a>ä»‹ç»è¿‡Java SDKæä¾›äº†2ä¸ªæœ‰ç•Œé˜Ÿåˆ—ï¼šArrayBlockingQueue å’Œ LinkedBlockingQueueï¼Œå®ƒä»¬éƒ½æ˜¯åŸºäºReentrantLockå®ç°çš„ï¼Œåœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹ï¼Œé”çš„æ•ˆç‡å¹¶ä¸é«˜ï¼Œé‚£æœ‰æ²¡æœ‰æ›´å¥½çš„æ›¿ä»£å“å‘¢ï¼Ÿæœ‰ï¼Œä»Šå¤©æˆ‘ä»¬å°±ä»‹ç»ä¸€ç§æ€§èƒ½æ›´é«˜çš„æœ‰ç•Œé˜Ÿåˆ—ï¼šDisruptorã€‚</p><p><strong>Disruptoræ˜¯ä¸€æ¬¾é«˜æ€§èƒ½çš„æœ‰ç•Œå†…å­˜é˜Ÿåˆ—</strong>ï¼Œç›®å‰åº”ç”¨éå¸¸å¹¿æ³›ï¼ŒLog4j2ã€Spring Messagingã€HBaseã€Storméƒ½ç”¨åˆ°äº†Disruptorï¼Œé‚£Disruptorçš„æ€§èƒ½ä¸ºä»€ä¹ˆè¿™ä¹ˆé«˜å‘¢ï¼ŸDisruptoré¡¹ç›®å›¢é˜Ÿæ›¾ç»å†™è¿‡ä¸€ç¯‡è®ºæ–‡ï¼Œè¯¦ç»†è§£é‡Šäº†å…¶åŸå› ï¼Œå¯ä»¥æ€»ç»“ä¸ºå¦‚ä¸‹ï¼š</p><ol>
<li>å†…å­˜åˆ†é…æ›´åŠ åˆç†ï¼Œä½¿ç”¨RingBufferæ•°æ®ç»“æ„ï¼Œæ•°ç»„å…ƒç´ åœ¨åˆå§‹åŒ–æ—¶ä¸€æ¬¡æ€§å…¨éƒ¨åˆ›å»ºï¼Œæå‡ç¼“å­˜å‘½ä¸­ç‡ï¼›å¯¹è±¡å¾ªç¯åˆ©ç”¨ï¼Œé¿å…é¢‘ç¹GCã€‚</li>
<li>èƒ½å¤Ÿé¿å…ä¼ªå…±äº«ï¼Œæå‡ç¼“å­˜åˆ©ç”¨ç‡ã€‚</li>
<li>é‡‡ç”¨æ— é”ç®—æ³•ï¼Œé¿å…é¢‘ç¹åŠ é”ã€è§£é”çš„æ€§èƒ½æ¶ˆè€—ã€‚</li>
<li>æ”¯æŒæ‰¹é‡æ¶ˆè´¹ï¼Œæ¶ˆè´¹è€…å¯ä»¥æ— é”æ–¹å¼æ¶ˆè´¹å¤šä¸ªæ¶ˆæ¯ã€‚</li>
</ol><p>å…¶ä¸­ï¼Œå‰ä¸‰ç‚¹æ¶‰åŠåˆ°çš„çŸ¥è¯†æ¯”è¾ƒå¤šï¼Œæ‰€ä»¥ä»Šå¤©å’±ä»¬é‡ç‚¹è®²è§£å‰ä¸‰ç‚¹ï¼Œä¸è¿‡åœ¨è¯¦ç»†ä»‹ç»è¿™äº›çŸ¥è¯†ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆæ¥èŠèŠDisruptorå¦‚ä½•ä½¿ç”¨ï¼Œå¥½è®©ä½ å…ˆå¯¹Disruptoræœ‰ä¸ªæ„Ÿå®˜çš„è®¤è¯†ã€‚</p><!-- [[[read_end]]] --><p>ä¸‹é¢çš„ä»£ç å‡ºè‡ªå®˜æ–¹ç¤ºä¾‹ï¼Œæˆ‘ç•¥åšäº†ä¸€äº›ä¿®æ”¹ï¼Œç›¸è¾ƒè€Œè¨€ï¼ŒDisruptorçš„ä½¿ç”¨æ¯”Java SDKæä¾›BlockingQueueè¦å¤æ‚ä¸€äº›ï¼Œä½†æ˜¯æ€»ä½“æ€è·¯è¿˜æ˜¯ä¸€è‡´çš„ï¼Œå…¶å¤§è‡´æƒ…å†µå¦‚ä¸‹ï¼š</p><ul>
<li>åœ¨Disruptorä¸­ï¼Œç”Ÿäº§è€…ç”Ÿäº§çš„å¯¹è±¡ï¼ˆä¹Ÿå°±æ˜¯æ¶ˆè´¹è€…æ¶ˆè´¹çš„å¯¹è±¡ï¼‰ç§°ä¸ºEventï¼Œä½¿ç”¨Disruptorå¿…é¡»è‡ªå®šä¹‰Eventï¼Œä¾‹å¦‚ç¤ºä¾‹ä»£ç çš„è‡ªå®šä¹‰Eventæ˜¯LongEventï¼›</li>
<li>æ„å»ºDisruptorå¯¹è±¡é™¤äº†è¦æŒ‡å®šé˜Ÿåˆ—å¤§å°å¤–ï¼Œè¿˜éœ€è¦ä¼ å…¥ä¸€ä¸ªEventFactoryï¼Œç¤ºä¾‹ä»£ç ä¸­ä¼ å…¥çš„æ˜¯<code>LongEvent::new</code>ï¼›</li>
<li>æ¶ˆè´¹Disruptorä¸­çš„Eventéœ€è¦é€šè¿‡handleEventsWith()æ–¹æ³•æ³¨å†Œä¸€ä¸ªäº‹ä»¶å¤„ç†å™¨ï¼Œå‘å¸ƒEventåˆ™éœ€è¦é€šè¿‡publishEvent()æ–¹æ³•ã€‚</li>
</ul><pre><code>//è‡ªå®šä¹‰Event
class LongEvent {
  private long value;
  public void set(long value) {
    this.value = value;
  }
}
//æŒ‡å®šRingBufferå¤§å°,
//å¿…é¡»æ˜¯2çš„Næ¬¡æ–¹
int bufferSize = 1024;

//æ„å»ºDisruptor
Disruptor&lt;LongEvent&gt; disruptor 
  = new Disruptor&lt;&gt;(
    LongEvent::new,
    bufferSize,
    DaemonThreadFactory.INSTANCE);

//æ³¨å†Œäº‹ä»¶å¤„ç†å™¨
disruptor.handleEventsWith(
  (event, sequence, endOfBatch) -&gt;
    System.out.println(&quot;E: &quot;+event));

//å¯åŠ¨Disruptor
disruptor.start();

//è·å–RingBuffer
RingBuffer&lt;LongEvent&gt; ringBuffer 
  = disruptor.getRingBuffer();
//ç”Ÿäº§Event
ByteBuffer bb = ByteBuffer.allocate(8);
for (long l = 0; true; l++){
  bb.putLong(0, l);
  //ç”Ÿäº§è€…ç”Ÿäº§æ¶ˆæ¯
  ringBuffer.publishEvent(
    (event, sequence, buffer) -&gt; 
      event.set(buffer.getLong(0)), bb);
  Thread.sleep(1000);
}
</code></pre><h2>RingBufferå¦‚ä½•æå‡æ€§èƒ½</h2><p>Java SDKä¸­ArrayBlockingQueueä½¿ç”¨<strong>æ•°ç»„</strong>ä½œä¸ºåº•å±‚çš„æ•°æ®å­˜å‚¨ï¼Œè€ŒDisruptoræ˜¯ä½¿ç”¨<strong>RingBuffer</strong>ä½œä¸ºæ•°æ®å­˜å‚¨ã€‚RingBufferæœ¬è´¨ä¸Šä¹Ÿæ˜¯æ•°ç»„ï¼Œæ‰€ä»¥ä»…ä»…å°†æ•°æ®å­˜å‚¨ä»æ•°ç»„æ¢æˆRingBufferå¹¶ä¸èƒ½æå‡æ€§èƒ½ï¼Œä½†æ˜¯Disruptoråœ¨RingBufferçš„åŸºç¡€ä¸Šè¿˜åšäº†å¾ˆå¤šä¼˜åŒ–ï¼Œå…¶ä¸­ä¸€é¡¹ä¼˜åŒ–å°±æ˜¯å’Œå†…å­˜åˆ†é…æœ‰å…³çš„ã€‚</p><p>åœ¨ä»‹ç»è¿™é¡¹ä¼˜åŒ–ä¹‹å‰ï¼Œä½ éœ€è¦å…ˆäº†è§£ä¸€ä¸‹ç¨‹åºçš„å±€éƒ¨æ€§åŸç†ã€‚ç®€å•æ¥è®²ï¼Œ<strong>ç¨‹åºçš„å±€éƒ¨æ€§åŸç†æŒ‡çš„æ˜¯åœ¨ä¸€æ®µæ—¶é—´å†…ç¨‹åºçš„æ‰§è¡Œä¼šé™å®šåœ¨ä¸€ä¸ªå±€éƒ¨èŒƒå›´å†…</strong>ã€‚è¿™é‡Œçš„â€œå±€éƒ¨æ€§â€å¯ä»¥ä»ä¸¤ä¸ªæ–¹é¢æ¥ç†è§£ï¼Œä¸€ä¸ªæ˜¯æ—¶é—´å±€éƒ¨æ€§ï¼Œå¦ä¸€ä¸ªæ˜¯ç©ºé—´å±€éƒ¨æ€§ã€‚<strong>æ—¶é—´å±€éƒ¨æ€§</strong>æŒ‡çš„æ˜¯ç¨‹åºä¸­çš„æŸæ¡æŒ‡ä»¤ä¸€æ—¦è¢«æ‰§è¡Œï¼Œä¸ä¹…ä¹‹åè¿™æ¡æŒ‡ä»¤å¾ˆå¯èƒ½å†æ¬¡è¢«æ‰§è¡Œï¼›å¦‚æœæŸæ¡æ•°æ®è¢«è®¿é—®ï¼Œä¸ä¹…ä¹‹åè¿™æ¡æ•°æ®å¾ˆå¯èƒ½å†æ¬¡è¢«è®¿é—®ã€‚è€Œ<strong>ç©ºé—´å±€éƒ¨æ€§</strong>æ˜¯æŒ‡æŸå—å†…å­˜ä¸€æ—¦è¢«è®¿é—®ï¼Œä¸ä¹…ä¹‹åè¿™å—å†…å­˜é™„è¿‘çš„å†…å­˜ä¹Ÿå¾ˆå¯èƒ½è¢«è®¿é—®ã€‚</p><p>CPUçš„ç¼“å­˜å°±åˆ©ç”¨äº†ç¨‹åºçš„å±€éƒ¨æ€§åŸç†ï¼šCPUä»å†…å­˜ä¸­åŠ è½½æ•°æ®Xæ—¶ï¼Œä¼šå°†æ•°æ®Xç¼“å­˜åœ¨é«˜é€Ÿç¼“å­˜Cacheä¸­ï¼Œå®é™…ä¸ŠCPUç¼“å­˜Xçš„åŒæ—¶ï¼Œè¿˜ç¼“å­˜äº†Xå‘¨å›´çš„æ•°æ®ï¼Œå› ä¸ºæ ¹æ®ç¨‹åºå…·å¤‡å±€éƒ¨æ€§åŸç†ï¼ŒXå‘¨å›´çš„æ•°æ®ä¹Ÿå¾ˆæœ‰å¯èƒ½è¢«è®¿é—®ã€‚ä»å¦å¤–ä¸€ä¸ªè§’åº¦æ¥çœ‹ï¼Œå¦‚æœç¨‹åºèƒ½å¤Ÿå¾ˆå¥½åœ°ä½“ç°å‡ºå±€éƒ¨æ€§åŸç†ï¼Œä¹Ÿå°±èƒ½æ›´å¥½åœ°åˆ©ç”¨CPUçš„ç¼“å­˜ï¼Œä»è€Œæå‡ç¨‹åºçš„æ€§èƒ½ã€‚Disruptoråœ¨è®¾è®¡RingBufferçš„æ—¶å€™å°±å……åˆ†è€ƒè™‘äº†è¿™ä¸ªé—®é¢˜ï¼Œä¸‹é¢æˆ‘ä»¬å°±å¯¹æ¯”ç€ArrayBlockingQueueæ¥åˆ†æä¸€ä¸‹ã€‚</p><p>é¦–å…ˆæ˜¯ArrayBlockingQueueã€‚ç”Ÿäº§è€…çº¿ç¨‹å‘ArrayBlockingQueueå¢åŠ ä¸€ä¸ªå…ƒç´ ï¼Œæ¯æ¬¡å¢åŠ å…ƒç´ Eä¹‹å‰ï¼Œéƒ½éœ€è¦åˆ›å»ºä¸€ä¸ªå¯¹è±¡Eï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼ŒArrayBlockingQueueå†…éƒ¨æœ‰6ä¸ªå…ƒç´ ï¼Œè¿™6ä¸ªå…ƒç´ éƒ½æ˜¯ç”±ç”Ÿäº§è€…çº¿ç¨‹åˆ›å»ºçš„ï¼Œç”±äºåˆ›å»ºè¿™äº›å…ƒç´ çš„æ—¶é—´åŸºæœ¬ä¸Šæ˜¯ç¦»æ•£çš„ï¼Œæ‰€ä»¥è¿™äº›å…ƒç´ çš„å†…å­˜åœ°å€å¤§æ¦‚ç‡ä¹Ÿä¸æ˜¯è¿ç»­çš„ã€‚</p><p><img src="https://static001.geekbang.org/resource/image/84/90/848fd30644355ea86f3f91b06bfafa90.png" alt=""></p><center><span class="reference">ArrayBlockingQueueå†…éƒ¨ç»“æ„å›¾</span></center><p>ä¸‹é¢æˆ‘ä»¬å†çœ‹çœ‹Disruptoræ˜¯å¦‚ä½•å¤„ç†çš„ã€‚Disruptorå†…éƒ¨çš„RingBufferä¹Ÿæ˜¯ç”¨æ•°ç»„å®ç°çš„ï¼Œä½†æ˜¯è¿™ä¸ªæ•°ç»„ä¸­çš„æ‰€æœ‰å…ƒç´ åœ¨åˆå§‹åŒ–æ—¶æ˜¯ä¸€æ¬¡æ€§å…¨éƒ¨åˆ›å»ºçš„ï¼Œæ‰€ä»¥è¿™äº›å…ƒç´ çš„å†…å­˜åœ°å€å¤§æ¦‚ç‡æ˜¯è¿ç»­çš„ï¼Œç›¸å…³çš„ä»£ç å¦‚ä¸‹æ‰€ç¤ºã€‚</p><pre><code>for (int i=0; i&lt;bufferSize; i++){
  //entries[]å°±æ˜¯RingBufferå†…éƒ¨çš„æ•°ç»„
  //eventFactoryå°±æ˜¯å‰é¢ç¤ºä¾‹ä»£ç ä¸­ä¼ å…¥çš„LongEvent::new
  entries[BUFFER_PAD + i] 
    = eventFactory.newInstance();
}
</code></pre><p>Disruptorå†…éƒ¨RingBufferçš„ç»“æ„å¯ä»¥ç®€åŒ–æˆä¸‹å›¾ï¼Œé‚£é—®é¢˜æ¥äº†ï¼Œæ•°ç»„ä¸­æ‰€æœ‰å…ƒç´ å†…å­˜åœ°å€è¿ç»­èƒ½æå‡æ€§èƒ½å—ï¼Ÿèƒ½ï¼ä¸ºä»€ä¹ˆå‘¢ï¼Ÿå› ä¸ºæ¶ˆè´¹è€…çº¿ç¨‹åœ¨æ¶ˆè´¹çš„æ—¶å€™ï¼Œæ˜¯éµå¾ªç©ºé—´å±€éƒ¨æ€§åŸç†çš„ï¼Œæ¶ˆè´¹å®Œç¬¬1ä¸ªå…ƒç´ ï¼Œå¾ˆå¿«å°±ä¼šæ¶ˆè´¹ç¬¬2ä¸ªå…ƒç´ ï¼›å½“æ¶ˆè´¹ç¬¬1ä¸ªå…ƒç´ E1çš„æ—¶å€™ï¼ŒCPUä¼šæŠŠå†…å­˜ä¸­E1åé¢çš„æ•°æ®ä¹ŸåŠ è½½è¿›Cacheï¼Œå¦‚æœE1å’ŒE2åœ¨å†…å­˜ä¸­çš„åœ°å€æ˜¯è¿ç»­çš„ï¼Œé‚£ä¹ˆE2ä¹Ÿå°±ä¼šè¢«åŠ è½½è¿›Cacheä¸­ï¼Œç„¶åå½“æ¶ˆè´¹ç¬¬2ä¸ªå…ƒç´ çš„æ—¶å€™ï¼Œç”±äºE2å·²ç»åœ¨Cacheä¸­äº†ï¼Œæ‰€ä»¥å°±ä¸éœ€è¦ä»å†…å­˜ä¸­åŠ è½½äº†ï¼Œè¿™æ ·å°±èƒ½å¤§å¤§æå‡æ€§èƒ½ã€‚</p><p><img src="https://static001.geekbang.org/resource/image/33/37/33bc0d35615f5d5f7869871e0cfed037.png" alt=""></p><center><span class="reference">Disruptorå†…éƒ¨RingBufferç»“æ„å›¾</span></center><p>é™¤æ­¤ä¹‹å¤–ï¼Œåœ¨Disruptorä¸­ï¼Œç”Ÿäº§è€…çº¿ç¨‹é€šè¿‡publishEvent()å‘å¸ƒEventçš„æ—¶å€™ï¼Œå¹¶ä¸æ˜¯åˆ›å»ºä¸€ä¸ªæ–°çš„Eventï¼Œè€Œæ˜¯é€šè¿‡event.set()æ–¹æ³•ä¿®æ”¹Eventï¼Œ ä¹Ÿå°±æ˜¯è¯´RingBufferåˆ›å»ºçš„Eventæ˜¯å¯ä»¥å¾ªç¯åˆ©ç”¨çš„ï¼Œè¿™æ ·è¿˜èƒ½é¿å…é¢‘ç¹åˆ›å»ºã€åˆ é™¤Eventå¯¼è‡´çš„é¢‘ç¹GCé—®é¢˜ã€‚</p><h2>å¦‚ä½•é¿å…â€œä¼ªå…±äº«â€</h2><p>é«˜æ•ˆåˆ©ç”¨Cacheï¼Œèƒ½å¤Ÿå¤§å¤§æå‡æ€§èƒ½ï¼Œæ‰€ä»¥è¦åŠªåŠ›æ„å»ºèƒ½å¤Ÿé«˜æ•ˆåˆ©ç”¨Cacheçš„å†…å­˜ç»“æ„ã€‚è€Œä»å¦å¤–ä¸€ä¸ªè§’åº¦çœ‹ï¼ŒåŠªåŠ›é¿å…ä¸èƒ½é«˜æ•ˆåˆ©ç”¨Cacheçš„å†…å­˜ç»“æ„ä¹ŸåŒæ ·é‡è¦ã€‚</p><p>æœ‰ä¸€ç§å«åšâ€œä¼ªå…±äº«ï¼ˆFalse sharingï¼‰â€çš„å†…å­˜å¸ƒå±€å°±ä¼šä½¿Cacheå¤±æ•ˆï¼Œé‚£ä»€ä¹ˆæ˜¯â€œä¼ªå…±äº«â€å‘¢ï¼Ÿ</p><p>ä¼ªå…±äº«å’ŒCPUå†…éƒ¨çš„Cacheæœ‰å…³ï¼ŒCacheå†…éƒ¨æ˜¯æŒ‰ç…§ç¼“å­˜è¡Œï¼ˆCache Lineï¼‰ç®¡ç†çš„ï¼Œç¼“å­˜è¡Œçš„å¤§å°é€šå¸¸æ˜¯64ä¸ªå­—èŠ‚ï¼›CPUä»å†…å­˜ä¸­åŠ è½½æ•°æ®Xï¼Œä¼šåŒæ—¶åŠ è½½Xåé¢ï¼ˆ64-size(X)ï¼‰ä¸ªå­—èŠ‚çš„æ•°æ®ã€‚ä¸‹é¢çš„ç¤ºä¾‹ä»£ç å‡ºè‡ªJava SDKçš„ArrayBlockingQueueï¼Œå…¶å†…éƒ¨ç»´æŠ¤äº†4ä¸ªæˆå‘˜å˜é‡ï¼Œåˆ†åˆ«æ˜¯é˜Ÿåˆ—æ•°ç»„itemsã€å‡ºé˜Ÿç´¢å¼•takeIndexã€å…¥é˜Ÿç´¢å¼•putIndexä»¥åŠé˜Ÿåˆ—ä¸­çš„å…ƒç´ æ€»æ•°countã€‚</p><pre><code>/** é˜Ÿåˆ—æ•°ç»„ */
final Object[] items;
/** å‡ºé˜Ÿç´¢å¼• */
int takeIndex;
/** å…¥é˜Ÿç´¢å¼• */
int putIndex;
/** é˜Ÿåˆ—ä¸­å…ƒç´ æ€»æ•° */
int count;
</code></pre><p>å½“CPUä»å†…å­˜ä¸­åŠ è½½takeIndexçš„æ—¶å€™ï¼Œä¼šåŒæ—¶å°†putIndexä»¥åŠcountéƒ½åŠ è½½è¿›Cacheã€‚ä¸‹å›¾æ˜¯æŸä¸ªæ—¶åˆ»CPUä¸­Cacheçš„çŠ¶å†µï¼Œä¸ºäº†ç®€åŒ–ï¼Œç¼“å­˜è¡Œä¸­æˆ‘ä»¬ä»…åˆ—å‡ºäº†takeIndexå’ŒputIndexã€‚</p><p><img src="https://static001.geekbang.org/resource/image/fd/5c/fdccf96bda79453e55ed75e418864b5c.png" alt=""></p><center><span class="reference">CPUç¼“å­˜ç¤ºæ„å›¾</span></center><p>å‡è®¾çº¿ç¨‹Aè¿è¡Œåœ¨CPU-1ä¸Šï¼Œæ‰§è¡Œå…¥é˜Ÿæ“ä½œï¼Œå…¥é˜Ÿæ“ä½œä¼šä¿®æ”¹putIndexï¼Œè€Œä¿®æ”¹putIndexä¼šå¯¼è‡´å…¶æ‰€åœ¨çš„æ‰€æœ‰æ ¸ä¸Šçš„ç¼“å­˜è¡Œå‡å¤±æ•ˆï¼›æ­¤æ—¶å‡è®¾è¿è¡Œåœ¨CPU-2ä¸Šçš„çº¿ç¨‹æ‰§è¡Œå‡ºé˜Ÿæ“ä½œï¼Œå‡ºé˜Ÿæ“ä½œéœ€è¦è¯»å–takeIndexï¼Œç”±äºtakeIndexæ‰€åœ¨çš„ç¼“å­˜è¡Œå·²ç»å¤±æ•ˆï¼Œæ‰€ä»¥CPU-2å¿…é¡»ä»å†…å­˜ä¸­é‡æ–°è¯»å–ã€‚å…¥é˜Ÿæ“ä½œæœ¬ä¸ä¼šä¿®æ”¹takeIndexï¼Œä½†æ˜¯ç”±äºtakeIndexå’ŒputIndexå…±äº«çš„æ˜¯ä¸€ä¸ªç¼“å­˜è¡Œï¼Œå°±å¯¼è‡´å‡ºé˜Ÿæ“ä½œä¸èƒ½å¾ˆå¥½åœ°åˆ©ç”¨Cacheï¼Œè¿™å…¶å®å°±æ˜¯<strong>ä¼ªå…±äº«</strong>ã€‚ç®€å•æ¥è®²ï¼Œ<strong>ä¼ªå…±äº«æŒ‡çš„æ˜¯ç”±äºå…±äº«ç¼“å­˜è¡Œå¯¼è‡´ç¼“å­˜æ— æ•ˆçš„åœºæ™¯</strong>ã€‚</p><p>ArrayBlockingQueueçš„å…¥é˜Ÿå’Œå‡ºé˜Ÿæ“ä½œæ˜¯ç”¨é”æ¥ä¿è¯äº’æ–¥çš„ï¼Œæ‰€ä»¥å…¥é˜Ÿå’Œå‡ºé˜Ÿä¸ä¼šåŒæ—¶å‘ç”Ÿã€‚å¦‚æœå…è®¸å…¥é˜Ÿå’Œå‡ºé˜ŸåŒæ—¶å‘ç”Ÿï¼Œé‚£å°±ä¼šå¯¼è‡´çº¿ç¨‹Aå’Œçº¿ç¨‹Bäº‰ç”¨åŒä¸€ä¸ªç¼“å­˜è¡Œï¼Œè¿™æ ·ä¹Ÿä¼šå¯¼è‡´æ€§èƒ½é—®é¢˜ã€‚æ‰€ä»¥ä¸ºäº†æ›´å¥½åœ°åˆ©ç”¨ç¼“å­˜ï¼Œæˆ‘ä»¬å¿…é¡»é¿å…ä¼ªå…±äº«ï¼Œé‚£å¦‚ä½•é¿å…å‘¢ï¼Ÿ</p><p><img src="https://static001.geekbang.org/resource/image/d5/27/d5d5afc11fe6b1aaf8c9be7dba643827.png" alt=""></p><center><span class="reference">CPUç¼“å­˜å¤±æ•ˆç¤ºæ„å›¾</span></center><p>æ–¹æ¡ˆå¾ˆç®€å•ï¼Œ<strong>æ¯ä¸ªå˜é‡ç‹¬å ä¸€ä¸ªç¼“å­˜è¡Œã€ä¸å…±äº«ç¼“å­˜è¡Œ</strong>å°±å¯ä»¥äº†ï¼Œå…·ä½“æŠ€æœ¯æ˜¯<strong>ç¼“å­˜è¡Œå¡«å……</strong>ã€‚æ¯”å¦‚æƒ³è®©takeIndexç‹¬å ä¸€ä¸ªç¼“å­˜è¡Œï¼Œå¯ä»¥åœ¨takeIndexçš„å‰åå„å¡«å……56ä¸ªå­—èŠ‚ï¼Œè¿™æ ·å°±ä¸€å®šèƒ½ä¿è¯takeIndexç‹¬å ä¸€ä¸ªç¼“å­˜è¡Œã€‚ä¸‹é¢çš„ç¤ºä¾‹ä»£ç å‡ºè‡ªDisruptorï¼ŒSequence å¯¹è±¡ä¸­çš„valueå±æ€§å°±èƒ½é¿å…ä¼ªå…±äº«ï¼Œå› ä¸ºè¿™ä¸ªå±æ€§å‰åéƒ½å¡«å……äº†56ä¸ªå­—èŠ‚ã€‚Disruptorä¸­å¾ˆå¤šå¯¹è±¡ï¼Œä¾‹å¦‚RingBufferã€RingBufferå†…éƒ¨çš„æ•°ç»„éƒ½ç”¨åˆ°äº†è¿™ç§å¡«å……æŠ€æœ¯æ¥é¿å…ä¼ªå…±äº«ã€‚</p><pre><code>//å‰ï¼šå¡«å……56å­—èŠ‚
class LhsPadding{
    long p1, p2, p3, p4, p5, p6, p7;
}
class Value extends LhsPadding{
    volatile long value;
}
//åï¼šå¡«å……56å­—èŠ‚
class RhsPadding extends Value{
    long p9, p10, p11, p12, p13, p14, p15;
}
class Sequence extends RhsPadding{
  //çœç•¥å®ç°
}
</code></pre><h2>Disruptorä¸­çš„æ— é”ç®—æ³•</h2><p>ArrayBlockingQueueæ˜¯åˆ©ç”¨ç®¡ç¨‹å®ç°çš„ï¼Œä¸­è§„ä¸­çŸ©ï¼Œç”Ÿäº§ã€æ¶ˆè´¹æ“ä½œéƒ½éœ€è¦åŠ é”ï¼Œå®ç°èµ·æ¥ç®€å•ï¼Œä½†æ˜¯æ€§èƒ½å¹¶ä¸ååˆ†ç†æƒ³ã€‚Disruptoré‡‡ç”¨çš„æ˜¯æ— é”ç®—æ³•ï¼Œå¾ˆå¤æ‚ï¼Œä½†æ˜¯æ ¸å¿ƒæ— éæ˜¯ç”Ÿäº§å’Œæ¶ˆè´¹ä¸¤ä¸ªæ“ä½œã€‚Disruptorä¸­æœ€å¤æ‚çš„æ˜¯å…¥é˜Ÿæ“ä½œï¼Œæ‰€ä»¥æˆ‘ä»¬é‡ç‚¹æ¥çœ‹çœ‹å…¥é˜Ÿæ“ä½œæ˜¯å¦‚ä½•å®ç°çš„ã€‚</p><p>å¯¹äºå…¥é˜Ÿæ“ä½œï¼Œæœ€å…³é”®çš„è¦æ±‚æ˜¯ä¸èƒ½è¦†ç›–æ²¡æœ‰æ¶ˆè´¹çš„å…ƒç´ ï¼›å¯¹äºå‡ºé˜Ÿæ“ä½œï¼Œæœ€å…³é”®çš„è¦æ±‚æ˜¯ä¸èƒ½è¯»å–æ²¡æœ‰å†™å…¥çš„å…ƒç´ ï¼Œæ‰€ä»¥Disruptorä¸­ä¹Ÿä¸€å®šä¼šç»´æŠ¤ç±»ä¼¼å‡ºé˜Ÿç´¢å¼•å’Œå…¥é˜Ÿç´¢å¼•è¿™æ ·ä¸¤ä¸ªå…³é”®å˜é‡ã€‚Disruptorä¸­çš„RingBufferç»´æŠ¤äº†å…¥é˜Ÿç´¢å¼•ï¼Œä½†æ˜¯å¹¶æ²¡æœ‰ç»´æŠ¤å‡ºé˜Ÿç´¢å¼•ï¼Œè¿™æ˜¯å› ä¸ºåœ¨Disruptorä¸­å¤šä¸ªæ¶ˆè´¹è€…å¯ä»¥åŒæ—¶æ¶ˆè´¹ï¼Œæ¯ä¸ªæ¶ˆè´¹è€…éƒ½ä¼šæœ‰ä¸€ä¸ªå‡ºé˜Ÿç´¢å¼•ï¼Œæ‰€ä»¥RingBufferçš„å‡ºé˜Ÿç´¢å¼•æ˜¯æ‰€æœ‰æ¶ˆè´¹è€…é‡Œé¢æœ€å°çš„é‚£ä¸€ä¸ªã€‚</p><p>ä¸‹é¢æ˜¯Disruptorç”Ÿäº§è€…å…¥é˜Ÿæ“ä½œçš„æ ¸å¿ƒä»£ç ï¼Œçœ‹ä¸Šå»å¾ˆå¤æ‚ï¼Œå…¶å®é€»è¾‘å¾ˆç®€å•ï¼šå¦‚æœæ²¡æœ‰è¶³å¤Ÿçš„ç©ºä½™ä½ç½®ï¼Œå°±å‡ºè®©CPUä½¿ç”¨æƒï¼Œç„¶åé‡æ–°è®¡ç®—ï¼›åä¹‹åˆ™ç”¨CASè®¾ç½®å…¥é˜Ÿç´¢å¼•ã€‚</p><pre><code>//ç”Ÿäº§è€…è·å–nä¸ªå†™å…¥ä½ç½®
do {
  //cursorç±»ä¼¼äºå…¥é˜Ÿç´¢å¼•ï¼ŒæŒ‡çš„æ˜¯ä¸Šæ¬¡ç”Ÿäº§åˆ°è¿™é‡Œ
  current = cursor.get();
  //ç›®æ ‡æ˜¯åœ¨ç”Ÿäº§nä¸ª
  next = current + n;
  //å‡æ‰ä¸€ä¸ªå¾ªç¯
  long wrapPoint = next - bufferSize;
  //è·å–ä¸Šä¸€æ¬¡çš„æœ€å°æ¶ˆè´¹ä½ç½®
  long cachedGatingSequence = gatingSequenceCache.get();
  //æ²¡æœ‰è¶³å¤Ÿçš„ç©ºä½™ä½ç½®
  if (wrapPoint&gt;cachedGatingSequence || cachedGatingSequence&gt;current){
    //é‡æ–°è®¡ç®—æ‰€æœ‰æ¶ˆè´¹è€…é‡Œé¢çš„æœ€å°å€¼ä½ç½®
    long gatingSequence = Util.getMinimumSequence(
        gatingSequences, current);
    //ä»ç„¶æ²¡æœ‰è¶³å¤Ÿçš„ç©ºä½™ä½ç½®ï¼Œå‡ºè®©CPUä½¿ç”¨æƒï¼Œé‡æ–°æ‰§è¡Œä¸‹ä¸€å¾ªç¯
    if (wrapPoint &gt; gatingSequence){
      LockSupport.parkNanos(1);
      continue;
    }
    //ä»æ–°è®¾ç½®ä¸Šä¸€æ¬¡çš„æœ€å°æ¶ˆè´¹ä½ç½®
    gatingSequenceCache.set(gatingSequence);
  } else if (cursor.compareAndSet(current, next)){
    //è·å–å†™å…¥ä½ç½®æˆåŠŸï¼Œè·³å‡ºå¾ªç¯
    break;
  }
} while (true);
</code></pre><h2>æ€»ç»“</h2><p>Disruptoråœ¨ä¼˜åŒ–å¹¶å‘æ€§èƒ½æ–¹é¢å¯è°“æ˜¯åšåˆ°äº†æè‡´ï¼Œä¼˜åŒ–çš„æ€è·¯å¤§ä½“æ˜¯ä¸¤ä¸ªæ–¹é¢ï¼Œä¸€ä¸ªæ˜¯åˆ©ç”¨æ— é”ç®—æ³•é¿å…é”çš„äº‰ç”¨ï¼Œå¦å¤–ä¸€ä¸ªåˆ™æ˜¯å°†ç¡¬ä»¶ï¼ˆCPUï¼‰çš„æ€§èƒ½å‘æŒ¥åˆ°æè‡´ã€‚å°¤å…¶æ˜¯åè€…ï¼Œåœ¨Javaé¢†åŸŸåŸºæœ¬ä¸Šå±äºç»å…¸ä¹‹ä½œäº†ã€‚</p><p>å‘æŒ¥ç¡¬ä»¶çš„èƒ½åŠ›ä¸€èˆ¬æ˜¯Cè¿™ç§é¢å‘ç¡¬ä»¶çš„è¯­è¨€å¸¸å¹²çš„äº‹å„¿ï¼ŒCè¯­è¨€é¢†åŸŸç»å¸¸é€šè¿‡è°ƒæ•´å†…å­˜å¸ƒå±€ä¼˜åŒ–å†…å­˜å ç”¨ï¼Œè€ŒJavaé¢†åŸŸåˆ™ç”¨çš„å¾ˆå°‘ï¼ŒåŸå› åœ¨äºJavaå¯ä»¥æ™ºèƒ½åœ°ä¼˜åŒ–å†…å­˜å¸ƒå±€ï¼Œå†…å­˜å¸ƒå±€å¯¹Javaç¨‹åºå‘˜çš„é€æ˜çš„ã€‚è¿™ç§æ™ºèƒ½çš„ä¼˜åŒ–å¤§éƒ¨åˆ†åœºæ™¯æ˜¯å¾ˆå‹å¥½çš„ï¼Œä½†æ˜¯å¦‚æœä½ æƒ³é€šè¿‡å¡«å……æ–¹å¼é¿å…ä¼ªå…±äº«å°±å¿…é¡»ç»•è¿‡è¿™ç§ä¼˜åŒ–ï¼Œå…³äºè¿™æ–¹é¢Disruptoræä¾›äº†ç»å…¸çš„å®ç°ï¼Œä½ å¯ä»¥å‚è€ƒã€‚</p><p>ç”±äºä¼ªå…±äº«é—®é¢˜å¦‚æ­¤é‡è¦ï¼Œæ‰€ä»¥Javaä¹Ÿå¼€å§‹é‡è§†å®ƒäº†ï¼Œæ¯”å¦‚Java 8ä¸­ï¼Œæä¾›äº†é¿å…ä¼ªå…±äº«çš„æ³¨è§£ï¼š@sun.misc.Contendedï¼Œé€šè¿‡è¿™ä¸ªæ³¨è§£å°±èƒ½è½»æ¾é¿å…ä¼ªå…±äº«ï¼ˆéœ€è¦è®¾ç½®JVMå‚æ•°-XX:-RestrictContendedï¼‰ã€‚ä¸è¿‡é¿å…ä¼ªå…±äº«æ˜¯ä»¥ç‰ºç‰²å†…å­˜ä¸ºä»£ä»·çš„ï¼Œæ‰€ä»¥å…·ä½“ä½¿ç”¨çš„æ—¶å€™è¿˜æ˜¯éœ€è¦ä»”ç»†æ–Ÿé…Œã€‚</p><p>æ¬¢è¿åœ¨ç•™è¨€åŒºä¸æˆ‘åˆ†äº«ä½ çš„æƒ³æ³•ï¼Œä¹Ÿæ¬¢è¿ä½ åœ¨ç•™è¨€åŒºè®°å½•ä½ çš„æ€è€ƒè¿‡ç¨‹ã€‚æ„Ÿè°¢é˜…è¯»ï¼Œå¦‚æœä½ è§‰å¾—è¿™ç¯‡æ–‡ç« å¯¹ä½ æœ‰å¸®åŠ©çš„è¯ï¼Œä¹Ÿæ¬¢è¿æŠŠå®ƒåˆ†äº«ç»™æ›´å¤šçš„æœ‹å‹ã€‚</p><p><img src="https://static001.geekbang.org/resource/image/cf/aa/cf393cd748a4f0e6451807c4b61843aa.jpg" alt=""></p><h2>ç²¾é€‰ç•™è¨€ï¼š</h2>
        <ul>
        
<li>
    <div>
        <div style="color: #888;font-size:15.25px;font-weight:400;line-height:1.2">
            å­™å¿—å¼º  2019-05-30 11:37:02
        </div>
        <div style="color:#353535;font-weight:400;white-space:normal;word-break:break-all;line-height:1.6">
            ç¨‹åºå±€éƒ¨æ€§åŸç†çš„ç©ºé—´å±€éƒ¨æ€§æ˜¯ä¸æ˜¯cpuåˆ†æ”¯é¢„æµ‹?ç¼“å­˜è¡Œä¸€èˆ¬æ˜¯64å­—èŠ‚,takeIndexé‚£ä¸ºä½•å‰åå¡«å……56ä¸ªå­—èŠ‚,å¤§äº64äº†,æ€ä¹ˆç‹¬å ç¼“å­˜è¡Œ? [5èµ]
        </div>
        
    </div>
</li>
            
<br/>

<li>
    <div>
        <div style="color: #888;font-size:15.25px;font-weight:400;line-height:1.2">
            é”¦  2019-05-30 20:51:11
        </div>
        <div style="color:#353535;font-weight:400;white-space:normal;word-break:break-all;line-height:1.6">
            disruptoré«˜æ€§èƒ½ä¸»è¦æ˜¯ä»¥ä¸‹å‡ ç‚¹è®¾è®¡ï¼š<br>1ï¼Œä»…ç»´æŠ¤ä¸€ä¸ªå…±äº«å˜é‡(å…¥é˜Ÿç´¢å¼•)ï¼Œå‡å°‘é”ç«äº‰ï¼Œå¹¶åˆ©ç”¨å¡«å……è¡ŒæŠ€æœ¯è§£å†³å…±äº«å˜é‡çš„ä¼ªå…±äº«é—®é¢˜ã€‚<br>2ï¼Œåº•å±‚ä½¿ç”¨å¾ªç¯æ•°ç»„ä½œä¸ºå­˜å‚¨ç»“æ„ï¼Œå¼€è¾Ÿä¸€ç»„è¿ç»­çš„å†…å­˜ç©ºé—´ï¼Œå¾ªç¯åˆ©ç”¨å‡å°‘gcæ¬¡æ•°ï¼Œå¹¶å……åˆ†åˆ©ç”¨äº†ç¨‹åºå±€éƒ¨æ€§åŸç†ã€‚<br>3ï¼Œå…¥é˜Ÿæ—¶æ”¯æŒä¸€æ¬¡æ€§è·å–å¤šä¸ªç´¢å¼•ï¼Œç„¶ååœ¨å½“å‰çº¿ç¨‹å†™å…¥æ•°æ®ï¼Œå‡å°‘é”ç«äº‰ï¼Œæ¶ˆè´¹æ—¶ä¸€æ ·ã€‚<br>ä¸çŸ¥é“æˆ‘ç†è§£çš„å¯¹ä¸å¯¹ï¼Ÿ [1èµ]
        </div>
        
    </div>
</li>
            
<br/>

<li>
    <div>
        <div style="color: #888;font-size:15.25px;font-weight:400;line-height:1.2">
            LW  2019-05-30 14:42:41
        </div>
        <div style="color:#353535;font-weight:400;white-space:normal;word-break:break-all;line-height:1.6">
            RingBufferæ˜¯ä¸€ä¸ªç¯å½¢é˜Ÿåˆ—ï¼Ÿ [1èµ]
        </div>
        
    </div>
</li>
            
<br/>

<li>
    <div>
        <div style="color: #888;font-size:15.25px;font-weight:400;line-height:1.2">
            Juc  2019-05-30 13:51:34
        </div>
        <div style="color:#353535;font-weight:400;white-space:normal;word-break:break-all;line-height:1.6">
            å¸Œæœ›è€å¸ˆè§£é‡Šä¸‹ï¼Œä¸ºä»€ä¹ˆåˆ›å»ºå…ƒç´ çš„æ—¶é—´ç¦»æ•£ä¼šå¯¼è‡´å…ƒç´ çš„å†…å­˜åœ°å€ä¸æ˜¯è¿ç»­çš„?è¿™äº›å…ƒç´ ä¸æ˜¯å­˜åœ¨æ•°ç»„ä¸­çš„å—ï¼Ÿæ•°ç»„åˆå§‹åŒ–ä¸æ˜¯å·²ç»è¿ç»­åˆ†é…å†…å­˜äº†å—ï¼Ÿ [1èµ]
        </div>
        <br/>
<div>
    <div style="color:#888;font-size:15.25px;font-weight:400;line-height:1.2">ä½œè€…å›å¤2019-05-30 22:34:59</div>
    <div style="color:#353535;font-weight:400;white-space:normal;word-break:break-all;line-height:1.6">æ•°ç»„è¿ç»­ï¼Œæ•°ç»„é‡Œåªæœ‰å¼•ç”¨ï¼Œe1 e2è¿™äº›å¯¹è±¡çš„åœ°å€ä¸è¿ç»­</div>
</div>
            
    </div>
</li>
            
<br/>

<li>
    <div>
        <div style="color: #888;font-size:15.25px;font-weight:400;line-height:1.2">
            å¼ ä¸‰  2019-05-30 08:26:38
        </div>
        <div style="color:#353535;font-weight:400;white-space:normal;word-break:break-all;line-height:1.6">
            æ‰“å¡ï¼ [1èµ]
        </div>
        
    </div>
</li>
            
<br/>

<li>
    <div>
        <div style="color: #888;font-size:15.25px;font-weight:400;line-height:1.2">
            QQæ€ª  2019-05-30 18:39:06
        </div>
        <div style="color:#353535;font-weight:400;white-space:normal;word-break:break-all;line-height:1.6">
            å‰å®³äº†æˆ‘çš„å“¥ï¼Œå°½ç„¶çœ‹æ‡‚äº†ï¼Œåˆå­¦åˆ°äº†è°¢è°¢è€å¸ˆ 
        </div>
        <br/>
<div>
    <div style="color:#888;font-size:15.25px;font-weight:400;line-height:1.2">ä½œè€…å›å¤2019-05-30 22:30:44</div>
    <div style="color:#353535;font-weight:400;white-space:normal;word-break:break-all;line-height:1.6">ğŸ‘</div>
</div>
            
    </div>
</li>
            
<br/>

<li>
    <div>
        <div style="color: #888;font-size:15.25px;font-weight:400;line-height:1.2">
            æ™“æ°  2019-05-30 17:52:44
        </div>
        <div style="color:#353535;font-weight:400;white-space:normal;word-break:break-all;line-height:1.6">
            mysqlä¹Ÿåˆ©ç”¨äº†ç¨‹åºçš„å±€éƒ¨æ€§åŸç†æ¥å‡å°‘ç£ç›˜çš„ioï¼Œç™¾åº¦å¼€æºçš„åˆ†å¸ƒå¼å”¯ä¸€idç”Ÿæˆå™¨ä¹Ÿä½¿ç”¨äº†RingBufferï¼Œå°†æå‰ç”Ÿæˆçš„idç¼“å­˜åˆ°RingBufferä¸­ã€‚ 
        </div>
        
    </div>
</li>
            
<br/>

<li>
    <div>
        <div style="color: #888;font-size:15.25px;font-weight:400;line-height:1.2">
            Simon  2019-05-30 14:10:23
        </div>
        <div style="color:#353535;font-weight:400;white-space:normal;word-break:break-all;line-height:1.6">
            é’ˆå¯¹å¡«å……çš„ä»£ç æˆ‘è¯´è¯´æˆ‘çš„çœ‹æ³•:<br><br>å¡«å……æ˜¯é’ˆå¯¹volatileå˜é‡çš„, ä¸€ä¸ªlongå 8ä¸ªå­—èŠ‚, æç«¯æƒ…å†µä¸‹, ç¼“å­˜è¡ŒåŠ è½½äº†7ä¸ªlongäº†, å†åŠ è½½ä¸€ä¸ªlongæ­£å¥½å¤Ÿä¸€ä¸ªç¼“å­˜è¡Œ, è¿™ä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆè¦åœ¨å‰é¢å¡«å……7ä¸ªlong, å‘åå¡«å……7ä¸ªlongä¹Ÿæ˜¯ä¸€æ ·çš„, æç«¯æƒ…å†µä¸‹, ç¼“å†²è¡Œçš„å‰8ä¸ªå­—èŠ‚å°±æ˜¯volatileçš„value, è¿™æ ·å‘åå¡«å……7ä¸ªlong, ä¹Ÿè¾¾åˆ°äº†64å­—èŠ‚.<br>åœ¨å‰åéƒ½å¡«å……7ä¸ªlong, å°±æ˜¯ä¸ºä¿è¯æ— è®ºæ€ä¹ˆåŠ è½½, éƒ½èƒ½ä¿è¯ä¸€ä¸ªç¼“å­˜è¡Œé‡Œåªæœ‰ä¸€ä¸ªvolatileçš„long.<br><br>è¿™æ˜¯æˆ‘çš„ç†è§£, ä¸çŸ¥é“å¯¹ä¸å¯¹.<br><br>è¿˜æœ‰ä¸ªé—®é¢˜éœ€è¦è¯·æ•™ä¸‹è€å¸ˆ, é‚£å°±æ˜¯, å¦‚æœæŸäº›cpuçš„ç¼“å­˜è¡Œä¸æ˜¯64å­—èŠ‚çš„, è¿™æ ·å¡«å……æ˜¯æœ‰é—®é¢˜çš„å§?<br> 
        </div>
        <br/>
<div>
    <div style="color:#888;font-size:15.25px;font-weight:400;line-height:1.2">ä½œè€…å›å¤2019-05-30 22:36:43</div>
    <div style="color:#353535;font-weight:400;white-space:normal;word-break:break-all;line-height:1.6">æ›¾ç»çœ‹åˆ°ä¸€ä¸ªèµ„æ–™è¯´java8é‚£ä¸ªæ³¨è§£å¡«å……çš„æ˜¯128ä½</div>
</div>
            
    </div>
</li>
            
<br/>

<li>
    <div>
        <div style="color: #888;font-size:15.25px;font-weight:400;line-height:1.2">
            henry  2019-05-30 12:10:19
        </div>
        <div style="color:#353535;font-weight:400;white-space:normal;word-break:break-all;line-height:1.6">
            æˆ‘ç”¨è¿‡apache stormï¼Œä¹‹å‰æƒ³äº†è§£åº•å±‚åŸç†ï¼Œåœ¨ç½‘ä¸ŠæŸ¥èµ„æ–™è¯´æ˜¯ç”¨åˆ°äº†disruptor, ç„¶åçœ‹åˆ°ç½‘ä¸Šçš„èµ„æ–™è¯´å®ƒå¿«çš„åŸå› å°±æ˜¯ç”¨åˆ°äº†ä¼ªå…±äº«ï¼Œä½†æ˜¯ç½‘ä¸Šéƒ½æ²¡æœ‰è¯´åˆ°ç‚¹ä¸Šï¼Œå°±æ˜¯æŠŠä¼ªå…±äº«çš„åŸç†è¯´äº†ä¸€éã€‚ã€‚ã€‚çœ‹çš„äº‘é‡Œé›¾é‡Œçš„ï¼Œçœ‹äº†è€å¸ˆçš„æ–‡ç« æ€»ç®—æ˜¯æ˜ç™½äº†ï¼Œä¸»è¦æ˜¯é’ˆå¯¹å…¥é˜Ÿå’Œå‡ºé˜Ÿç´¢å¼•ï¼Œè®©å®ƒä»¬åˆ†åˆ«ç‹¬å è¡Œï¼Œä¸å¤Ÿå­—èŠ‚æ•°çš„è¡¥å…¨ 
        </div>
        
    </div>
</li>
            
<br/>

<li>
    <div>
        <div style="color: #888;font-size:15.25px;font-weight:400;line-height:1.2">
            Rancood  2019-05-30 09:52:16
        </div>
        <div style="color:#353535;font-weight:400;white-space:normal;word-break:break-all;line-height:1.6">
            å¡«å……æŠ€æœ¯ä»£ç æ²¡æœ‰çœ‹æ‡‚ï¼Œèƒ½å¦åœ¨å…·ä½“è§£é‡Šä¸€ä¸‹ 
        </div>
        
    </div>
</li>
            
<br/>

<li>
    <div>
        <div style="color: #888;font-size:15.25px;font-weight:400;line-height:1.2">
            å‘¨æ²»æ…§  2019-05-30 09:15:01
        </div>
        <div style="color:#353535;font-weight:400;white-space:normal;word-break:break-all;line-height:1.6">
            æ€æƒ³å¾ˆä¸é”™å€¼å¾—å­¦ä¹ ï¼Œä¸€æ¬¡æ€§ç¼“å­˜é˜²æ­¢ç¼“å­˜åŒä¸€è¡Œå¯¼è‡´å¤±æ•ˆç”¨å¡«å……æ–¹å¼æ¥å¼¥è¡¥ï¼Œcasçš„æ— é”æœºåˆ¶ğŸ‘ğŸ»ğŸ‘ğŸ»ğŸ‘ğŸ»ğŸ‘ğŸ» 
        </div>
        
    </div>
</li>
            
<br/>

<li>
    <div>
        <div style="color: #888;font-size:15.25px;font-weight:400;line-height:1.2">
            è€æ¨åŒå¿—  2019-05-30 09:14:29
        </div>
        <div style="color:#353535;font-weight:400;white-space:normal;word-break:break-all;line-height:1.6">
            å¯¹Disruptorçš„æ— é”å¹¶å‘ç®—æ³•è¿˜æ˜¯ä¸€çŸ¥åŠè§£ã€‚è€Œä¸”æ‹…å¿ƒcpuä½¿ç”¨ç‡ä¼šä¸ä¼šå¾ˆé«˜ï¼Œåƒè€å¸ˆä»£ç ä¸­LockSupport.parkNanos(1); ä¼‘æ¯å¾ˆå°‘çš„æ—¶é—´å°±å›æ¥é‡æ–°äº‰å–cpuï¼Œè€ŒDisruptorä¸­æœ‰ä¸ªç­–ç•¥ä¸­ä½¿ç”¨Thread.yield( )ï¼Œäº¤å‡ºcpuåé©¬ä¸Šå›æ¥äº‰å¤ºï¼Œè¿™æ ·ä¼šä¸ä¼šæ˜¯cpuä½¿ç”¨ç‡é£™å‡å‘¢ 
        </div>
        
    </div>
</li>
            
<br/>

<li>
    <div>
        <div style="color: #888;font-size:15.25px;font-weight:400;line-height:1.2">
            å³°  2019-05-30 08:35:20
        </div>
        <div style="color:#353535;font-weight:400;white-space:normal;word-break:break-all;line-height:1.6">
            é€šè¿‡åˆå§‹åŒ–æ•°ç»„çš„æ—¶å€™å°†æ‰€æœ‰å…ƒç´ åˆå§‹åŒ–ï¼Œè¿™ä¸ªæ„Ÿè§‰å¾ˆä¾èµ–äºjvmæˆ–è€…æ“ä½œç³»ç»Ÿçš„å†…å­˜åˆ†é…ç­–ç•¥å‘€ï¼Œè€Œä¸”å¯¹è±¡æ•°ç»„ä¸­ä¸ä¹Ÿæœ‰å¼•ç”¨å—ï¼Œæ‰€ä»¥å°±ç®—èƒ½ç¼“å­˜å‹å¥½ï¼Œé‚£ä¹Ÿæ˜¯ä¸€å±‚è€Œå·²ï¼Œä¸ºä»€ä¹ˆä¸èƒ½ç›´æ¥åœ¨å †ä¸­æä¸€å—åŒºåŸŸå°±ç›´æ¥å­˜è¿™äº›ä¸ªä¸œä¸œå‘¢ã€‚ 
        </div>
        
    </div>
</li>
            
<br/>

<li>
    <div>
        <div style="color: #888;font-size:15.25px;font-weight:400;line-height:1.2">
            ææœªæ¥  2019-05-30 07:14:18
        </div>
        <div style="color:#353535;font-weight:400;white-space:normal;word-break:break-all;line-height:1.6">
            ä»¥å‰åªçŸ¥é“ç¼“å­˜è¡Œçš„å¥½å¤„ï¼Œè¿™æ¬¡çŸ¥é“äº†ç¼“å­˜è¡Œå¯èƒ½çš„åå¤„ï¼Œå—æ•™äº†ï¼ 
        </div>
        
    </div>
</li>
            </ul>
</div>
</body>
</html>