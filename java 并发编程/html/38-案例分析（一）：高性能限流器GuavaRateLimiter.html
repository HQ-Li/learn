<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN" "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title>38-æ¡ˆä¾‹åˆ†æï¼ˆä¸€ï¼‰ï¼šé«˜æ€§èƒ½é™æµå™¨GuavaRateLimiter</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8"/>
        <style>
        html {
            color: #333;
            -webkit-text-size-adjust: 100%;
            -ms-text-size-adjust: 100%;
            text-rendering: optimizelegibility;
            font-family: Helvetica Neue, PingFang SC, Verdana, Microsoft Yahei, Hiragino Sans GB, Microsoft Sans Serif, WenQuanYi Micro Hei, sans-serif
        }

        html.borderbox *,
        html.borderbox :after,
        html.borderbox :before {
            box-sizing: border-box
        }

        article,
        aside,
        blockquote,
        body,
        button,
        code,
        dd,
        details,
        dl,
        dt,
        fieldset,
        figcaption,
        figure,
        footer,
        form,
        h1,
        h2,
        h3,
        h4,
        h5,
        h6,
        header,
        hr,
        input,
        legend,
        li,
        menu,
        nav,
        ol,
        p,
        pre,
        section,
        td,
        textarea,
        th,
        ul {
            margin: 0;
            padding: 0
        }

        article,
        aside,
        details,
        figcaption,
        figure,
        footer,
        header,
        menu,
        nav,
        section {
            display: block
        }

        audio,
        canvas,
        video {
            display: inline-block
        }

        body,
        button,
        input,
        select,
        textarea {
            font: 300 1em/1.8 PingFang SC, Lantinghei SC, Microsoft Yahei, Hiragino Sans GB, Microsoft Sans Serif, WenQuanYi Micro Hei, Helvetica, sans-serif
        }

        button::-moz-focus-inner,
        input::-moz-focus-inner {
            padding: 0;
            border: 0
        }

        table {
            border-collapse: collapse;
            border-spacing: 0
        }

        fieldset,
        img {
            border: 0
        }

        blockquote {
            position: relative;
            color: #999;
            font-weight: 400;
            border-left: 1px solid #1abc9c;
            padding-left: 1em;
            margin: 1em 3em 1em 2em
        }

        @media only screen and (max-width: 640px) {
            blockquote {
                margin: 1em 0
            }
        }

        abbr,
        acronym {
            border-bottom: 1px dotted;
            font-variant: normal
        }

        abbr {
            cursor: help
        }

        del {
            text-decoration: line-through
        }

        address,
        caption,
        cite,
        code,
        dfn,
        em,
        th,
        var {
            font-style: normal;
            font-weight: 400
        }

        ol,
        ul {
            list-style: none
        }

        caption,
        th {
            text-align: left
        }

        q:after,
        q:before {
            content: ""
        }

        sub,
        sup {
            font-size: 75%;
            line-height: 0;
            position: relative
        }

        :root sub,
        :root sup {
            vertical-align: baseline
        }

        sup {
            top: -.5em
        }

        sub {
            bottom: -.25em
        }

        a {
            color: #1abc9c
        }

        a:hover {
            text-decoration: underline
        }

        .typo a {
            border-bottom: 1px solid #1abc9c
        }

        .typo a:hover {
            border-bottom-color: #555;
            color: #555
        }

        .typo a:hover,
        a,
        ins {
            text-decoration: none
        }

        .typo-u,
        u {
            text-decoration: underline
        }

        mark {
            background: #fffdd1;
            border-bottom: 1px solid #ffedce;
            padding: 2px;
            margin: 0 5px
        }

        code,
        pre,
        pre tt {
            font-family: Courier, Courier New, monospace
        }

        pre {
            background: hsla(0, 0%, 97%, .7);
            border: 1px solid #ddd;
            padding: 1em 1.5em;
            display: block;
            -webkit-overflow-scrolling: touch
        }

        hr {
            border: none;
            border-bottom: 1px solid #cfcfcf;
            margin-bottom: .8em;
            height: 10px
        }

        .typo-small,
        figcaption,
        small {
            font-size: .9em;
            color: #888
        }

        b,
        strong {
            font-weight: 700;
            color: #000
        }

        [draggable] {
            cursor: move
        }

        .clearfix:after,
        .clearfix:before {
            content: "";
            display: table
        }

        .clearfix:after {
            clear: both
        }

        .clearfix {
            zoom: 1
        }

        .textwrap,
        .textwrap td,
        .textwrap th {
            word-wrap: break-word;
            word-break: break-all
        }

        .textwrap-table {
            table-layout: fixed
        }

        .serif {
            font-family: Palatino, Optima, Georgia, serif
        }

        .typo-dl,
        .typo-form,
        .typo-hr,
        .typo-ol,
        .typo-p,
        .typo-pre,
        .typo-table,
        .typo-ul,
        .typo dl,
        .typo form,
        .typo hr,
        .typo ol,
        .typo p,
        .typo pre,
        .typo table,
        .typo ul,
        blockquote {
            margin-bottom: 1rem
        }

        h1,
        h2,
        h3,
        h4,
        h5,
        h6 {
            font-family: PingFang SC, Helvetica Neue, Verdana, Microsoft Yahei, Hiragino Sans GB, Microsoft Sans Serif, WenQuanYi Micro Hei, sans-serif;
            color: #000;
            line-height: 1.35
        }

        .typo-h1,
        .typo-h2,
        .typo-h3,
        .typo-h4,
        .typo-h5,
        .typo-h6,
        .typo h1,
        .typo h2,
        .typo h3,
        .typo h4,
        .typo h5,
        .typo h6 {
            margin-top: 1.2em;
            margin-bottom: .6em;
            line-height: 1.35
        }

        .typo-h1,
        .typo h1 {
            font-size: 2em
        }

        .typo-h2,
        .typo h2 {
            font-size: 1.8em
        }

        .typo-h3,
        .typo h3 {
            font-size: 1.6em
        }

        .typo-h4,
        .typo h4 {
            font-size: 1.4em
        }

        .typo-h5,
        .typo-h6,
        .typo h5,
        .typo h6 {
            font-size: 1.2em
        }

        .typo-ul,
        .typo ul {
            margin-left: 1.3em;
            list-style: disc
        }

        .typo-ol,
        .typo ol {
            list-style: decimal;
            margin-left: 1.9em
        }

        .typo-ol ol,
        .typo-ol ul,
        .typo-ul ol,
        .typo-ul ul,
        .typo li ol,
        .typo li ul {
            margin-bottom: .8em;
            margin-left: 2em
        }

        .typo-ol ul,
        .typo-ul ul,
        .typo li ul {
            list-style: circle
        }

        .typo-table td,
        .typo-table th,
        .typo table caption,
        .typo table td,
        .typo table th {
            border: 1px solid #ddd;
            padding: .5em 1em;
            color: #666
        }

        .typo-table th,
        .typo table th {
            background: #fbfbfb
        }

        .typo-table thead th,
        .typo table thead th {
            background: hsla(0, 0%, 95%, .7)
        }

        .typo table caption {
            border-bottom: none
        }

        .typo-input,
        .typo-textarea {
            -webkit-appearance: none;
            border-radius: 0
        }

        .typo-em,
        .typo em,
        caption,
        legend {
            color: #000;
            font-weight: inherit
        }

        .typo-em {
            position: relative
        }

        .typo-em:after {
            position: absolute;
            top: .65em;
            left: 0;
            width: 100%;
            overflow: hidden;
            white-space: nowrap;
            content: "\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB\30FB"
        }

        .typo img {
            max-width: 100%
        }

        .common-content {
            font-weight: 400;
            color: #353535;
            line-height: 1.75rem;
            white-space: normal;
            word-break: normal;
            font-size: 1rem
        }

        .common-content img {
            display: block;
            max-width: 100%;
            background-color: #eee
        }

        .common-content audio,
        .common-content video {
            width: 100%;
            background-color: #eee
        }

        .common-content center,
        .common-content font {
            margin-top: 1rem;
            display: inline-block
        }

        .common-content center {
            width: 100%
        }

        .common-content pre {
            margin-top: 1rem;
            padding-left: 0;
            padding-right: 0;
            position: relative;
            overflow: hidden
        }

        .common-content pre code {
            font-size: .8rem;
            font-family: Consolas, Liberation Mono, Menlo, monospace, Courier;
            display: block;
            width: 100%;
            box-sizing: border-box;
            padding-left: 1rem;
            padding-right: 1rem;
            overflow-x: auto
        }

        .common-content hr {
            border: none;
            margin-top: 1.5rem;
            margin-bottom: 1.5rem;
            border-top: 1px solid #f5f5f5;
            height: 1px;
            background: none
        }

        .common-content b,
        .common-content h1,
        .common-content h2,
        .common-content h3,
        .common-content h4,
        .common-content h5,
        .common-content strong {
            font-weight: 700
        }

        .common-content h1,
        .common-content h2 {
            font-size: 1.125rem;
            margin-bottom: .45rem
        }

        .common-content h3,
        .common-content h4,
        .common-content h5 {
            font-size: 1rem;
            margin-bottom: .45rem
        }

        .common-content p {
            font-weight: 400;
            color: #353535;
            margin-top: .15rem
        }

        .common-content .orange {
            color: #ff5a05
        }

        .common-content .reference {
            font-size: 1rem;
            color: #888
        }

        .custom-rich-content h1 {
            margin-top: 0;
            font-weight: 400;
            font-size: 15.25px;
            border-bottom: 1px solid #eee;
            line-height: 2.8
        }

        .custom-rich-content li,
        .custom-rich-content p {
            font-size: 14px;
            color: #888;
            line-height: 1.6
        }

        table.hljs-ln {
            margin-bottom: 0;
            border-spacing: 0;
            border-collapse: collapse
        }

        table.hljs-ln,
        table.hljs-ln tbody,
        table.hljs-ln td,
        table.hljs-ln tr {
            box-sizing: border-box
        }

        table.hljs-ln td {
            padding: 0;
            border: 0
        }

        table.hljs-ln td.hljs-ln-numbers {
            min-width: 15px;
            color: rgba(27, 31, 35, .3);
            text-align: right;
            white-space: nowrap;
            cursor: pointer;
            user-select: none
        }

        table.hljs-ln td.hljs-ln-code,
        table.hljs-ln td.hljs-ln-numbers {
            font-family: SFMono-Regular, Consolas, Liberation Mono, Menlo, Courier, monospace;
            font-size: 12px;
            line-height: 20px;
            vertical-align: top
        }

        table.hljs-ln td.hljs-ln-code {
            position: relative;
            padding-right: 10px;
            padding-left: 10px;
            overflow: visible;
            color: #24292e;
            word-wrap: normal;
            white-space: pre
        }

        video::-webkit-media-controls {
            overflow: hidden !important
        }

        video::-webkit-media-controls-enclosure {
            width: calc(100% + 32px);
            margin-left: auto
        }

        ._29HP61GA_0 {
            max-width:800px;
            margin:0 auto;
            margin-bottom: 20px;
            font-weight: 400;
            color: #353535;
            line-height: 1.76;
            white-space: normal;
            word-break: normal;
            font-size: 17px;
            -webkit-transition: background-color .3s ease;
            transition: background-color .3s ease
        }

        ._29HP61GA_0 .MathJax_Display {
            overflow: auto
        }

        ._29HP61GA_0 .poster {
            position: fixed;
            left: -10000px;
            top: -10000px;
            overflow: hidden;
            padding: 1rem;
            background: #ececec
        }

        ._29HP61GA_0 .richcontent-pre-copy {
            font-size: 13px;
            color: #888;
            position: absolute;
            right: 1em;
            top: .5em;
            cursor: pointer;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none
        }

        ._29HP61GA_0 .richcontent-pre-copy .iconfont {
            font-size: 12px;
            margin-right: .2em
        }

        ._29HP61GA_0 a {
            color: #fa8919;
            border-bottom: 1px solid #fa8919
        }

        ._29HP61GA_0 img {
            display: block;
            max-width: 100%;
            position: relative;
            left: 50%;
            -webkit-transform: translateX(-50%);
            transform: translateX(-50%);
            background-color: #eee;
            vertical-align: top;
            border-radius: 0
        }

        ._29HP61GA_0 audio,
        ._29HP61GA_0 video {
            width: 100%;
            background-color: #eee
        }

        ._29HP61GA_0 pre {
            margin-top: 16px;
            padding: 34px 0 0;
            margin-bottom: 30px;
            position: relative;
            border-radius: 6px;
            background: rgba(246, 247, 251, .749);
            border: 0
        }

        ._29HP61GA_0 pre code {
            font-size: 12px;
            font-family: Consolas, Liberation Mono, Menlo, monospace, Courier;
            display: block;
            -webkit-box-sizing: border-box;
            box-sizing: border-box;
            margin-left: 16px;
            margin-right: 16px;
            overflow-x: scroll
        }

        ._29HP61GA_0 pre code:after {
            content: "";
            height: 30px;
            width: 100%;
            display: block
        }

        ._29HP61GA_0 hr {
            border: none;
            margin-top: 1.5rem;
            margin-bottom: 1.5rem;
            border-top: 1px solid #f5f5f5;
            height: 1px;
            background: none
        }

        ._29HP61GA_0 h1,
        ._29HP61GA_0 h2,
        ._29HP61GA_0 h3,
        ._29HP61GA_0 h4,
        ._29HP61GA_0 h5 {
            margin-bottom: 20px;
            margin-top: 0;
            font-weight: 700
        }

        ._29HP61GA_0 b,
        ._29HP61GA_0 strong {
            font-weight: 700
        }

        ._29HP61GA_0 h1 {
            font-size: 21px
        }

        ._29HP61GA_0 h2 {
            font-size: 20px
        }

        ._29HP61GA_0 h3 {
            font-size: 19px
        }

        ._29HP61GA_0 h4 {
            font-size: 18px
        }

        ._29HP61GA_0 h5 {
            font-size: 17px
        }

        ._29HP61GA_0 center,
        ._29HP61GA_0 p {
            font-weight: 400;
            color: #353535;
            margin-top: 0;
            margin-bottom: 30px;
            word-break: break-word
        }

        ._29HP61GA_0 center {
            text-align: center
        }

        ._29HP61GA_0 blockquote {
            margin-top: 0;
            margin-bottom: 34px;
            border-left: 3px solid #e8e8e8;
            padding-left: 17px;
            color: #353535
        }

        ._29HP61GA_0 blockquote p {
            margin-top: 0;
            margin-bottom: 0
        }

        ._29HP61GA_0 ol,
        ._29HP61GA_0 ul {
            margin-bottom: 30px
        }

        ._29HP61GA_0 ol p,
        ._29HP61GA_0 ul p {
            margin-top: 0;
            margin-bottom: 0
        }

        ._29HP61GA_0 ol {
            list-style: decimal;
            margin-left: 20px
        }

        ._29HP61GA_0 ul li {
            padding-left: 17px;
            position: relative;
            margin-bottom: 10px
        }

        ._29HP61GA_0 ul li:after {
            content: "";
            height: 6px;
            width: 6px;
            border-radius: 50%;
            background: #353535;
            position: absolute;
            top: 10px;
            left: 0
        }

        ._29HP61GA_0 .orange {
            color: #fa8919
        }

        ._29HP61GA_0 .reference {
            color: #888
        }

        ._29HP61GA_0 .m-right {
            text-align: right
        }

        ._29HP61GA_0 .m-center {
            text-align: center;
            display: block
        }

        ._29HP61GA_0 .m-gray {
            color: #888
        }

        ._29HP61GA_0 .m-small {
            font-size: 15px
        }

        ._29HP61GA_0 table.hljs-ln {
            margin-bottom: 0;
            border-spacing: 0;
            border-collapse: collapse
        }

        ._29HP61GA_0 table.hljs-ln,
        ._29HP61GA_0 table.hljs-ln tbody,
        ._29HP61GA_0 table.hljs-ln td,
        ._29HP61GA_0 table.hljs-ln tr {
            -webkit-box-sizing: border-box;
            box-sizing: border-box
        }

        ._29HP61GA_0 table.hljs-ln td {
            padding: 0;
            border: 0
        }

        ._29HP61GA_0 table.hljs-ln td.hljs-ln-numbers {
            min-width: 15px;
            font-size: 12px;
            color: rgba(27, 31, 35, .3);
            text-align: right;
            white-space: nowrap;
            cursor: pointer;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none
        }

        ._29HP61GA_0 table.hljs-ln td.hljs-ln-code,
        ._29HP61GA_0 table.hljs-ln td.hljs-ln-numbers {
            font-family: SFMono-Regular, Consolas, Liberation Mono, Menlo, Courier, monospace;
            line-height: 20px;
            vertical-align: top
        }

        ._29HP61GA_0 table.hljs-ln td.hljs-ln-code {
            position: relative;
            padding-right: 10px;
            padding-left: 10px;
            overflow: visible;
            font-size: 13px;
            color: #666;
            word-wrap: normal;
            white-space: pre
        }

    </style>
</head>
<body>
<div class="_29HP61GA_0">
<h1>38-æ¡ˆä¾‹åˆ†æï¼ˆä¸€ï¼‰ï¼šé«˜æ€§èƒ½é™æµå™¨GuavaRateLimiter</h1>
<p>ä»ä»Šå¤©å¼€å§‹ï¼Œæˆ‘ä»¬å°±è¿›å…¥æ¡ˆä¾‹åˆ†ææ¨¡å—äº†ã€‚ è¿™ä¸ªæ¨¡å—æˆ‘ä»¬å°†åˆ†æå››ä¸ªç»å…¸çš„å¼€æºæ¡†æ¶ï¼Œçœ‹çœ‹å®ƒä»¬æ˜¯å¦‚ä½•å¤„ç†å¹¶å‘é—®é¢˜çš„ï¼Œé€šè¿‡è¿™å››ä¸ªæ¡ˆä¾‹çš„å­¦ä¹ ï¼Œç›¸ä¿¡ä½ ä¼šå¯¹å¦‚ä½•è§£å†³å¹¶å‘é—®é¢˜æœ‰ä¸ªæ›´æ·±å…¥çš„è®¤è¯†ã€‚</p><p>é¦–å…ˆæˆ‘ä»¬æ¥çœ‹çœ‹<strong>Guava RateLimiteræ˜¯å¦‚ä½•è§£å†³é«˜å¹¶å‘åœºæ™¯ä¸‹çš„é™æµé—®é¢˜çš„</strong>ã€‚Guavaæ˜¯Googleå¼€æºçš„Javaç±»åº“ï¼Œæä¾›äº†ä¸€ä¸ªå·¥å…·ç±»RateLimiterã€‚æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹RateLimiterçš„ä½¿ç”¨ï¼Œè®©ä½ å¯¹é™æµæœ‰ä¸ªæ„Ÿå®˜çš„å°è±¡ã€‚å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªçº¿ç¨‹æ± ï¼Œå®ƒæ¯ç§’åªèƒ½å¤„ç†ä¸¤ä¸ªä»»åŠ¡ï¼Œå¦‚æœæäº¤çš„ä»»åŠ¡è¿‡å¿«ï¼Œå¯èƒ½å¯¼è‡´ç³»ç»Ÿä¸ç¨³å®šï¼Œè¿™ä¸ªæ—¶å€™å°±éœ€è¦ç”¨åˆ°é™æµã€‚</p><p>åœ¨ä¸‹é¢çš„ç¤ºä¾‹ä»£ç ä¸­ï¼Œæˆ‘ä»¬åˆ›å»ºäº†ä¸€ä¸ªæµé€Ÿä¸º2ä¸ªè¯·æ±‚/ç§’çš„é™æµå™¨ï¼Œè¿™é‡Œçš„æµé€Ÿè¯¥æ€ä¹ˆç†è§£å‘¢ï¼Ÿç›´è§‚åœ°çœ‹ï¼Œ2ä¸ªè¯·æ±‚/ç§’æŒ‡çš„æ˜¯æ¯ç§’æœ€å¤šå…è®¸2ä¸ªè¯·æ±‚é€šè¿‡é™æµå™¨ï¼Œå…¶å®åœ¨Guavaä¸­ï¼Œæµé€Ÿè¿˜æœ‰æ›´æ·±ä¸€å±‚çš„æ„æ€ï¼šæ˜¯ä¸€ç§åŒ€é€Ÿçš„æ¦‚å¿µï¼Œ2ä¸ªè¯·æ±‚/ç§’ç­‰ä»·äº1ä¸ªè¯·æ±‚/500æ¯«ç§’ã€‚</p><p>åœ¨å‘çº¿ç¨‹æ± æäº¤ä»»åŠ¡ä¹‹å‰ï¼Œè°ƒç”¨ <code>acquire()</code> æ–¹æ³•å°±èƒ½èµ·åˆ°é™æµçš„ä½œç”¨ã€‚é€šè¿‡ç¤ºä¾‹ä»£ç çš„æ‰§è¡Œç»“æœï¼Œä»»åŠ¡æäº¤åˆ°çº¿ç¨‹æ± çš„æ—¶é—´é—´éš”åŸºæœ¬ä¸Šç¨³å®šåœ¨500æ¯«ç§’ã€‚</p><pre><code>//é™æµå™¨æµé€Ÿï¼š2ä¸ªè¯·æ±‚/ç§’
RateLimiter limiter = 
  RateLimiter.create(2.0);
//æ‰§è¡Œä»»åŠ¡çš„çº¿ç¨‹æ± 
ExecutorService es = Executors
  .newFixedThreadPool(1);
//è®°å½•ä¸Šä¸€æ¬¡æ‰§è¡Œæ—¶é—´
prev = System.nanoTime();
//æµ‹è¯•æ‰§è¡Œ20æ¬¡
for (int i=0; i&lt;20; i++){
  //é™æµå™¨é™æµ
  limiter.acquire();
  //æäº¤ä»»åŠ¡å¼‚æ­¥æ‰§è¡Œ
  es.execute(()-&gt;{
    long cur=System.nanoTime();
    //æ‰“å°æ—¶é—´é—´éš”ï¼šæ¯«ç§’
    System.out.println(
      (cur-prev)/1000_000);
    prev = cur;
  });
}

è¾“å‡ºç»“æœï¼š
...
500
499
499
500
499
</code></pre><h2>ç»å…¸é™æµç®—æ³•ï¼šä»¤ç‰Œæ¡¶ç®—æ³•</h2><p>Guavaçš„é™æµå™¨ä½¿ç”¨ä¸Šè¿˜æ˜¯å¾ˆç®€å•çš„ï¼Œé‚£å®ƒæ˜¯å¦‚ä½•å®ç°çš„å‘¢ï¼ŸGuavaé‡‡ç”¨çš„æ˜¯<strong>ä»¤ç‰Œæ¡¶ç®—æ³•</strong>ï¼Œå…¶<strong>æ ¸å¿ƒæ˜¯è¦æƒ³é€šè¿‡é™æµå™¨ï¼Œå¿…é¡»æ‹¿åˆ°ä»¤ç‰Œ</strong>ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œåªè¦æˆ‘ä»¬èƒ½å¤Ÿé™åˆ¶å‘æ”¾ä»¤ç‰Œçš„é€Ÿç‡ï¼Œé‚£ä¹ˆå°±èƒ½æ§åˆ¶æµé€Ÿäº†ã€‚ä»¤ç‰Œæ¡¶ç®—æ³•çš„è¯¦ç»†æè¿°å¦‚ä¸‹ï¼š</p><!-- [[[read_end]]] --><ol>
<li>ä»¤ç‰Œä»¥å›ºå®šçš„é€Ÿç‡æ·»åŠ åˆ°ä»¤ç‰Œæ¡¶ä¸­ï¼Œå‡è®¾é™æµçš„é€Ÿç‡æ˜¯ r/ç§’ï¼Œåˆ™ä»¤ç‰Œæ¯ 1/r ç§’ä¼šæ·»åŠ ä¸€ä¸ªï¼›</li>
<li>å‡è®¾ä»¤ç‰Œæ¡¶çš„å®¹é‡æ˜¯ b ï¼Œå¦‚æœä»¤ç‰Œæ¡¶å·²æ»¡ï¼Œåˆ™æ–°çš„ä»¤ç‰Œä¼šè¢«ä¸¢å¼ƒï¼›</li>
<li>è¯·æ±‚èƒ½å¤Ÿé€šè¿‡é™æµå™¨çš„å‰ææ˜¯ä»¤ç‰Œæ¡¶ä¸­æœ‰ä»¤ç‰Œã€‚</li>
</ol><p>è¿™ä¸ªç®—æ³•ä¸­ï¼Œé™æµçš„é€Ÿç‡ r è¿˜æ˜¯æ¯”è¾ƒå®¹æ˜“ç†è§£çš„ï¼Œä½†ä»¤ç‰Œæ¡¶çš„å®¹é‡ b è¯¥æ€ä¹ˆç†è§£å‘¢ï¼Ÿb å…¶å®æ˜¯burstçš„ç®€å†™ï¼Œæ„ä¹‰æ˜¯<strong>é™æµå™¨å…è®¸çš„æœ€å¤§çªå‘æµé‡</strong>ã€‚æ¯”å¦‚b=10ï¼Œè€Œä¸”ä»¤ç‰Œæ¡¶ä¸­çš„ä»¤ç‰Œå·²æ»¡ï¼Œæ­¤æ—¶é™æµå™¨å…è®¸10ä¸ªè¯·æ±‚åŒæ—¶é€šè¿‡é™æµå™¨ï¼Œå½“ç„¶åªæ˜¯çªå‘æµé‡è€Œå·²ï¼Œè¿™10ä¸ªè¯·æ±‚ä¼šå¸¦èµ°10ä¸ªä»¤ç‰Œï¼Œæ‰€ä»¥åç»­çš„æµé‡åªèƒ½æŒ‰ç…§é€Ÿç‡ r é€šè¿‡é™æµå™¨ã€‚</p><p>ä»¤ç‰Œæ¡¶è¿™ä¸ªç®—æ³•ï¼Œå¦‚ä½•ç”¨Javaå®ç°å‘¢ï¼Ÿå¾ˆå¯èƒ½ä½ çš„ç›´è§‰ä¼šå‘Šè¯‰ä½ ç”Ÿäº§è€…-æ¶ˆè´¹è€…æ¨¡å¼ï¼šä¸€ä¸ªç”Ÿäº§è€…çº¿ç¨‹å®šæ—¶å‘é˜»å¡é˜Ÿåˆ—ä¸­æ·»åŠ ä»¤ç‰Œï¼Œè€Œè¯•å›¾é€šè¿‡é™æµå™¨çš„çº¿ç¨‹åˆ™ä½œä¸ºæ¶ˆè´¹è€…çº¿ç¨‹ï¼Œåªæœ‰ä»é˜»å¡é˜Ÿåˆ—ä¸­è·å–åˆ°ä»¤ç‰Œï¼Œæ‰å…è®¸é€šè¿‡é™æµå™¨ã€‚</p><p>è¿™ä¸ªç®—æ³•çœ‹ä¸Šå»éå¸¸å®Œç¾ï¼Œè€Œä¸”å®ç°èµ·æ¥éå¸¸ç®€å•ï¼Œå¦‚æœå¹¶å‘é‡ä¸å¤§ï¼Œè¿™ä¸ªå®ç°å¹¶æ²¡æœ‰ä»€ä¹ˆé—®é¢˜ã€‚å¯å®é™…æƒ…å†µå´æ˜¯ä½¿ç”¨é™æµçš„åœºæ™¯å¤§éƒ¨åˆ†éƒ½æ˜¯é«˜å¹¶å‘åœºæ™¯ï¼Œè€Œä¸”ç³»ç»Ÿå‹åŠ›å·²ç»ä¸´è¿‘æé™äº†ï¼Œæ­¤æ—¶è¿™ä¸ªå®ç°å°±æœ‰é—®é¢˜äº†ã€‚é—®é¢˜å°±å‡ºåœ¨å®šæ—¶å™¨ä¸Šï¼Œåœ¨é«˜å¹¶å‘åœºæ™¯ä¸‹ï¼Œå½“ç³»ç»Ÿå‹åŠ›å·²ç»ä¸´è¿‘æé™çš„æ—¶å€™ï¼Œå®šæ—¶å™¨çš„ç²¾åº¦è¯¯å·®ä¼šéå¸¸å¤§ï¼ŒåŒæ—¶å®šæ—¶å™¨æœ¬èº«ä¼šåˆ›å»ºè°ƒåº¦çº¿ç¨‹ï¼Œä¹Ÿä¼šå¯¹ç³»ç»Ÿçš„æ€§èƒ½äº§ç”Ÿå½±å“ã€‚</p><p>é‚£è¿˜æœ‰ä»€ä¹ˆå¥½çš„å®ç°æ–¹å¼å‘¢ï¼Ÿå½“ç„¶æœ‰ï¼ŒGuavaçš„å®ç°å°±æ²¡æœ‰ä½¿ç”¨å®šæ—¶å™¨ï¼Œä¸‹é¢æˆ‘ä»¬å°±æ¥çœ‹çœ‹å®ƒæ˜¯å¦‚ä½•å®ç°çš„ã€‚</p><h2>Guavaå¦‚ä½•å®ç°ä»¤ç‰Œæ¡¶ç®—æ³•</h2><p>Guavaå®ç°ä»¤ç‰Œæ¡¶ç®—æ³•ï¼Œç”¨äº†ä¸€ä¸ªå¾ˆç®€å•çš„åŠæ³•ï¼Œå…¶å…³é”®æ˜¯<strong>è®°å½•å¹¶åŠ¨æ€è®¡ç®—ä¸‹ä¸€ä»¤ç‰Œå‘æ”¾çš„æ—¶é—´</strong>ã€‚ä¸‹é¢æˆ‘ä»¬ä»¥ä¸€ä¸ªæœ€ç®€å•çš„åœºæ™¯æ¥ä»‹ç»è¯¥ç®—æ³•çš„æ‰§è¡Œè¿‡ç¨‹ã€‚å‡è®¾ä»¤ç‰Œæ¡¶çš„å®¹é‡ä¸º b=1ï¼Œé™æµé€Ÿç‡ r = 1ä¸ªè¯·æ±‚/ç§’ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œå¦‚æœå½“å‰ä»¤ç‰Œæ¡¶ä¸­æ²¡æœ‰ä»¤ç‰Œï¼Œä¸‹ä¸€ä¸ªä»¤ç‰Œçš„å‘æ”¾æ—¶é—´æ˜¯åœ¨ç¬¬3ç§’ï¼Œè€Œåœ¨ç¬¬2ç§’çš„æ—¶å€™æœ‰ä¸€ä¸ªçº¿ç¨‹T1è¯·æ±‚ä»¤ç‰Œï¼Œæ­¤æ—¶è¯¥å¦‚ä½•å¤„ç†å‘¢ï¼Ÿ</p><p><img src="https://static001.geekbang.org/resource/image/39/ce/391179821a55fc798c9c17a6991c1dce.png" alt=""></p><center><span class="reference">çº¿ç¨‹T1è¯·æ±‚ä»¤ç‰Œç¤ºæ„å›¾</span></center><p>å¯¹äºè¿™ä¸ªè¯·æ±‚ä»¤ç‰Œçš„çº¿ç¨‹è€Œè¨€ï¼Œå¾ˆæ˜¾ç„¶éœ€è¦ç­‰å¾…1ç§’ï¼Œå› ä¸º1ç§’ä»¥åï¼ˆç¬¬3ç§’ï¼‰å®ƒå°±èƒ½æ‹¿åˆ°ä»¤ç‰Œäº†ã€‚æ­¤æ—¶éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä¸‹ä¸€ä¸ªä»¤ç‰Œå‘æ”¾çš„æ—¶é—´ä¹Ÿè¦å¢åŠ 1ç§’ï¼Œä¸ºä»€ä¹ˆå‘¢ï¼Ÿå› ä¸ºç¬¬3ç§’å‘æ”¾çš„ä»¤ç‰Œå·²ç»è¢«çº¿ç¨‹T1é¢„å äº†ã€‚å¤„ç†ä¹‹åå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p><p><img src="https://static001.geekbang.org/resource/image/1a/87/1a4069c830e18de087ba7f490aa78087.png" alt=""></p><center><span class="reference">çº¿ç¨‹T1è¯·æ±‚ç»“æŸç¤ºæ„å›¾</span></center><p>å‡è®¾T1åœ¨é¢„å äº†ç¬¬3ç§’çš„ä»¤ç‰Œä¹‹åï¼Œé©¬ä¸Šåˆæœ‰ä¸€ä¸ªçº¿ç¨‹T2è¯·æ±‚ä»¤ç‰Œï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p><p><img src="https://static001.geekbang.org/resource/image/2c/2e/2cf695d0888a93e1e2d020d9514f5a2e.png" alt=""></p><center><span class="reference">çº¿ç¨‹T2è¯·æ±‚ä»¤ç‰Œç¤ºæ„å›¾</span></center><p>å¾ˆæ˜¾ç„¶ï¼Œç”±äºä¸‹ä¸€ä¸ªä»¤ç‰Œäº§ç”Ÿçš„æ—¶é—´æ˜¯ç¬¬4ç§’ï¼Œæ‰€ä»¥çº¿ç¨‹T2è¦ç­‰å¾…ä¸¤ç§’çš„æ—¶é—´ï¼Œæ‰èƒ½è·å–åˆ°ä»¤ç‰Œï¼ŒåŒæ—¶ç”±äºT2é¢„å äº†ç¬¬4ç§’çš„ä»¤ç‰Œï¼Œæ‰€ä»¥ä¸‹ä¸€ä»¤ç‰Œäº§ç”Ÿæ—¶é—´è¿˜è¦å¢åŠ 1ç§’ï¼Œå®Œå…¨å¤„ç†ä¹‹åï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p><p><img src="https://static001.geekbang.org/resource/image/68/f7/68c09a96049aacda7936c52b801c22f7.png" alt=""></p><center><span class="reference">çº¿ç¨‹T2è¯·æ±‚ç»“æŸç¤ºæ„å›¾</span></center><p>ä¸Šé¢çº¿ç¨‹T1ã€T2éƒ½æ˜¯åœ¨<strong>ä¸‹ä¸€ä»¤ç‰Œäº§ç”Ÿæ—¶é—´ä¹‹å‰</strong>è¯·æ±‚ä»¤ç‰Œï¼Œå¦‚æœçº¿ç¨‹åœ¨<strong>ä¸‹ä¸€ä»¤ç‰Œäº§ç”Ÿæ—¶é—´ä¹‹å</strong>è¯·æ±‚ä»¤ç‰Œä¼šå¦‚ä½•å‘¢ï¼Ÿå‡è®¾åœ¨çº¿ç¨‹T1è¯·æ±‚ä»¤ç‰Œä¹‹åçš„5ç§’ï¼Œä¹Ÿå°±æ˜¯ç¬¬7ç§’ï¼Œçº¿ç¨‹T3è¯·æ±‚ä»¤ç‰Œï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p><p><img src="https://static001.geekbang.org/resource/image/e3/5c/e3125d72eb3d84eabf6de6ab987e695c.png" alt=""></p><center><span class="reference">çº¿ç¨‹T3è¯·æ±‚ä»¤ç‰Œç¤ºæ„å›¾</span></center><p>ç”±äºåœ¨ç¬¬5ç§’å·²ç»äº§ç”Ÿäº†ä¸€ä¸ªä»¤ç‰Œï¼Œæ‰€ä»¥æ­¤æ—¶çº¿ç¨‹T3å¯ä»¥ç›´æ¥æ‹¿åˆ°ä»¤ç‰Œï¼Œè€Œæ— éœ€ç­‰å¾…ã€‚åœ¨ç¬¬7ç§’ï¼Œå®é™…ä¸Šé™æµå™¨èƒ½å¤Ÿäº§ç”Ÿ3ä¸ªä»¤ç‰Œï¼Œç¬¬5ã€6ã€7ç§’å„äº§ç”Ÿä¸€ä¸ªä»¤ç‰Œã€‚ç”±äºæˆ‘ä»¬å‡è®¾ä»¤ç‰Œæ¡¶çš„å®¹é‡æ˜¯1ï¼Œæ‰€ä»¥ç¬¬6ã€7ç§’äº§ç”Ÿçš„ä»¤ç‰Œå°±ä¸¢å¼ƒäº†ï¼Œå…¶å®ç­‰ä»·åœ°ä½ ä¹Ÿå¯ä»¥è®¤ä¸ºæ˜¯ä¿ç•™çš„ç¬¬7ç§’çš„ä»¤ç‰Œï¼Œä¸¢å¼ƒçš„ç¬¬5ã€6ç§’çš„ä»¤ç‰Œï¼Œä¹Ÿå°±æ˜¯è¯´ç¬¬7ç§’çš„ä»¤ç‰Œè¢«çº¿ç¨‹T3å æœ‰äº†ï¼Œäºæ˜¯ä¸‹ä¸€ä»¤ç‰Œçš„çš„äº§ç”Ÿæ—¶é—´åº”è¯¥æ˜¯ç¬¬8ç§’ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p><p><img src="https://static001.geekbang.org/resource/image/ba/fc/baf159d05b2abf650839e29a2399a4fc.png" alt=""></p><center><span class="reference">çº¿ç¨‹T3è¯·æ±‚ç»“æŸç¤ºæ„å›¾</span></center><p>é€šè¿‡ä¸Šé¢ç®€è¦åœ°åˆ†æï¼Œä½ ä¼šå‘ç°ï¼Œæˆ‘ä»¬<strong>åªéœ€è¦è®°å½•ä¸€ä¸ªä¸‹ä¸€ä»¤ç‰Œäº§ç”Ÿçš„æ—¶é—´ï¼Œå¹¶åŠ¨æ€æ›´æ–°å®ƒï¼Œå°±èƒ½å¤Ÿè½»æ¾å®Œæˆé™æµåŠŸèƒ½</strong>ã€‚æˆ‘ä»¬å¯ä»¥å°†ä¸Šé¢çš„è¿™ä¸ªç®—æ³•ä»£ç åŒ–ï¼Œç¤ºä¾‹ä»£ç å¦‚ä¸‹æ‰€ç¤ºï¼Œä¾ç„¶å‡è®¾ä»¤ç‰Œæ¡¶çš„å®¹é‡æ˜¯1ã€‚å…³é”®æ˜¯<strong>reserve()æ–¹æ³•</strong>ï¼Œè¿™ä¸ªæ–¹æ³•ä¼šä¸ºè¯·æ±‚ä»¤ç‰Œçš„çº¿ç¨‹é¢„åˆ†é…ä»¤ç‰Œï¼ŒåŒæ—¶è¿”å›è¯¥çº¿ç¨‹èƒ½å¤Ÿè·å–ä»¤ç‰Œçš„æ—¶é—´ã€‚å…¶å®ç°é€»è¾‘å°±æ˜¯ä¸Šé¢æåˆ°çš„ï¼šå¦‚æœçº¿ç¨‹è¯·æ±‚ä»¤ç‰Œçš„æ—¶é—´åœ¨ä¸‹ä¸€ä»¤ç‰Œäº§ç”Ÿæ—¶é—´ä¹‹åï¼Œé‚£ä¹ˆè¯¥çº¿ç¨‹ç«‹åˆ»å°±èƒ½å¤Ÿè·å–ä»¤ç‰Œï¼›åä¹‹ï¼Œå¦‚æœè¯·æ±‚æ—¶é—´åœ¨ä¸‹ä¸€ä»¤ç‰Œäº§ç”Ÿæ—¶é—´ä¹‹å‰ï¼Œé‚£ä¹ˆè¯¥çº¿ç¨‹æ˜¯åœ¨ä¸‹ä¸€ä»¤ç‰Œäº§ç”Ÿçš„æ—¶é—´è·å–ä»¤ç‰Œã€‚ç”±äºæ­¤æ—¶ä¸‹ä¸€ä»¤ç‰Œå·²ç»è¢«è¯¥çº¿ç¨‹é¢„å ï¼Œæ‰€ä»¥ä¸‹ä¸€ä»¤ç‰Œäº§ç”Ÿçš„æ—¶é—´éœ€è¦åŠ ä¸Š1ç§’ã€‚</p><pre><code>class SimpleLimiter {
  //ä¸‹ä¸€ä»¤ç‰Œäº§ç”Ÿæ—¶é—´
  long next = System.nanoTime();
  //å‘æ”¾ä»¤ç‰Œé—´éš”ï¼šçº³ç§’
  long interval = 1000_000_000;
  //é¢„å ä»¤ç‰Œï¼Œè¿”å›èƒ½å¤Ÿè·å–ä»¤ç‰Œçš„æ—¶é—´
  synchronized long reserve(long now){
    //è¯·æ±‚æ—¶é—´åœ¨ä¸‹ä¸€ä»¤ç‰Œäº§ç”Ÿæ—¶é—´ä¹‹å
    //é‡æ–°è®¡ç®—ä¸‹ä¸€ä»¤ç‰Œäº§ç”Ÿæ—¶é—´
    if (now &gt; next){
      //å°†ä¸‹ä¸€ä»¤ç‰Œäº§ç”Ÿæ—¶é—´é‡ç½®ä¸ºå½“å‰æ—¶é—´
      next = now;
    }
    //èƒ½å¤Ÿè·å–ä»¤ç‰Œçš„æ—¶é—´
    long at=next;
    //è®¾ç½®ä¸‹ä¸€ä»¤ç‰Œäº§ç”Ÿæ—¶é—´
    next += interval;
    //è¿”å›çº¿ç¨‹éœ€è¦ç­‰å¾…çš„æ—¶é—´
    return Math.max(at, 0L);
  }
  //ç”³è¯·ä»¤ç‰Œ
  void acquire() {
    //ç”³è¯·ä»¤ç‰Œæ—¶çš„æ—¶é—´
    long now = System.nanoTime();
    //é¢„å ä»¤ç‰Œ
    long at=reserve(now);
    long waitTime=max(at-now, 0);
    //æŒ‰ç…§æ¡ä»¶ç­‰å¾…
    if(waitTime &gt; 0) {
      try {
        TimeUnit.NANOSECONDS
          .sleep(waitTime);
      }catch(InterruptedException e){
        e.printStackTrace();
      }
    }
  }
}
</code></pre><p>å¦‚æœä»¤ç‰Œæ¡¶çš„å®¹é‡å¤§äº1ï¼Œåˆè¯¥å¦‚ä½•å¤„ç†å‘¢ï¼ŸæŒ‰ç…§ä»¤ç‰Œæ¡¶ç®—æ³•ï¼Œä»¤ç‰Œè¦é¦–å…ˆä»ä»¤ç‰Œæ¡¶ä¸­å‡ºï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦æŒ‰éœ€è®¡ç®—ä»¤ç‰Œæ¡¶ä¸­çš„æ•°é‡ï¼Œå½“æœ‰çº¿ç¨‹è¯·æ±‚ä»¤ç‰Œæ—¶ï¼Œå…ˆä»ä»¤ç‰Œæ¡¶ä¸­å‡ºã€‚å…·ä½“çš„ä»£ç å®ç°å¦‚ä¸‹æ‰€ç¤ºã€‚æˆ‘ä»¬å¢åŠ äº†ä¸€ä¸ª<strong>resync()æ–¹æ³•</strong>ï¼Œåœ¨è¿™ä¸ªæ–¹æ³•ä¸­ï¼Œå¦‚æœçº¿ç¨‹è¯·æ±‚ä»¤ç‰Œçš„æ—¶é—´åœ¨ä¸‹ä¸€ä»¤ç‰Œäº§ç”Ÿæ—¶é—´ä¹‹åï¼Œä¼šé‡æ–°è®¡ç®—ä»¤ç‰Œæ¡¶ä¸­çš„ä»¤ç‰Œæ•°ï¼Œ<strong>æ–°äº§ç”Ÿçš„ä»¤ç‰Œçš„è®¡ç®—å…¬å¼æ˜¯ï¼š(now-next)/interval</strong>ï¼Œä½ å¯å¯¹ç…§ä¸Šé¢çš„ç¤ºæ„å›¾æ¥ç†è§£ã€‚reserve()æ–¹æ³•ä¸­ï¼Œåˆ™å¢åŠ äº†å…ˆä»ä»¤ç‰Œæ¡¶ä¸­å‡ºä»¤ç‰Œçš„é€»è¾‘ï¼Œä¸è¿‡éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå¦‚æœä»¤ç‰Œæ˜¯ä»ä»¤ç‰Œæ¡¶ä¸­å‡ºçš„ï¼Œé‚£ä¹ˆnextå°±æ— éœ€å¢åŠ ä¸€ä¸ª interval äº†ã€‚</p><pre><code>class SimpleLimiter {
  //å½“å‰ä»¤ç‰Œæ¡¶ä¸­çš„ä»¤ç‰Œæ•°é‡
  long storedPermits = 0;
  //ä»¤ç‰Œæ¡¶çš„å®¹é‡
  long maxPermits = 3;
  //ä¸‹ä¸€ä»¤ç‰Œäº§ç”Ÿæ—¶é—´
  long next = System.nanoTime();
  //å‘æ”¾ä»¤ç‰Œé—´éš”ï¼šçº³ç§’
  long interval = 1000_000_000;
  
  //è¯·æ±‚æ—¶é—´åœ¨ä¸‹ä¸€ä»¤ç‰Œäº§ç”Ÿæ—¶é—´ä¹‹å,åˆ™
  // 1.é‡æ–°è®¡ç®—ä»¤ç‰Œæ¡¶ä¸­çš„ä»¤ç‰Œæ•°
  // 2.å°†ä¸‹ä¸€ä¸ªä»¤ç‰Œå‘æ”¾æ—¶é—´é‡ç½®ä¸ºå½“å‰æ—¶é—´
  void resync(long now) {
    if (now &gt; next) {
      //æ–°äº§ç”Ÿçš„ä»¤ç‰Œæ•°
      long newPermits=(now-next)/interval;
      //æ–°ä»¤ç‰Œå¢åŠ åˆ°ä»¤ç‰Œæ¡¶
      storedPermits=min(maxPermits, 
        storedPermits + newPermits);
      //å°†ä¸‹ä¸€ä¸ªä»¤ç‰Œå‘æ”¾æ—¶é—´é‡ç½®ä¸ºå½“å‰æ—¶é—´
      next = now;
    }
  }
  //é¢„å ä»¤ç‰Œï¼Œè¿”å›èƒ½å¤Ÿè·å–ä»¤ç‰Œçš„æ—¶é—´
  synchronized long reserve(long now){
    resync(now);
    //èƒ½å¤Ÿè·å–ä»¤ç‰Œçš„æ—¶é—´
    long at = next;
    //ä»¤ç‰Œæ¡¶ä¸­èƒ½æä¾›çš„ä»¤ç‰Œ
    long fb=min(1, storedPermits);
    //ä»¤ç‰Œå‡€éœ€æ±‚ï¼šé¦–å…ˆå‡æ‰ä»¤ç‰Œæ¡¶ä¸­çš„ä»¤ç‰Œ
    long nr = 1 - fb;
    //é‡æ–°è®¡ç®—ä¸‹ä¸€ä»¤ç‰Œäº§ç”Ÿæ—¶é—´
    next = next + nr*interval;
    //é‡æ–°è®¡ç®—ä»¤ç‰Œæ¡¶ä¸­çš„ä»¤ç‰Œ
    this.storedPermits -= fb;
    return at;
  }
  //ç”³è¯·ä»¤ç‰Œ
  void acquire() {
    //ç”³è¯·ä»¤ç‰Œæ—¶çš„æ—¶é—´
    long now = System.nanoTime();
    //é¢„å ä»¤ç‰Œ
    long at=reserve(now);
    long waitTime=max(at-now, 0);
    //æŒ‰ç…§æ¡ä»¶ç­‰å¾…
    if(waitTime &gt; 0) {
      try {
        TimeUnit.NANOSECONDS
          .sleep(waitTime);
      }catch(InterruptedException e){
        e.printStackTrace();
      }
    }
  }
}
</code></pre><h2>æ€»ç»“</h2><p>ç»å…¸çš„é™æµç®—æ³•æœ‰ä¸¤ä¸ªï¼Œä¸€ä¸ªæ˜¯<strong>ä»¤ç‰Œæ¡¶ç®—æ³•ï¼ˆToken Bucketï¼‰</strong>ï¼Œå¦ä¸€ä¸ªæ˜¯<strong>æ¼æ¡¶ç®—æ³•ï¼ˆLeaky Bucketï¼‰</strong>ã€‚ä»¤ç‰Œæ¡¶ç®—æ³•æ˜¯å®šæ—¶å‘ä»¤ç‰Œæ¡¶å‘é€ä»¤ç‰Œï¼Œè¯·æ±‚èƒ½å¤Ÿä»ä»¤ç‰Œæ¡¶ä¸­æ‹¿åˆ°ä»¤ç‰Œï¼Œç„¶åæ‰èƒ½é€šè¿‡é™æµå™¨ï¼›è€Œæ¼æ¡¶ç®—æ³•é‡Œï¼Œè¯·æ±‚å°±åƒæ°´ä¸€æ ·æ³¨å…¥æ¼æ¡¶ï¼Œæ¼æ¡¶ä¼šæŒ‰ç…§ä¸€å®šçš„é€Ÿç‡è‡ªåŠ¨å°†æ°´æ¼æ‰ï¼Œåªæœ‰æ¼æ¡¶é‡Œè¿˜èƒ½æ³¨å…¥æ°´çš„æ—¶å€™ï¼Œè¯·æ±‚æ‰èƒ½é€šè¿‡é™æµå™¨ã€‚ä»¤ç‰Œæ¡¶ç®—æ³•å’Œæ¼æ¡¶ç®—æ³•å¾ˆåƒä¸€ä¸ªç¡¬å¸çš„æ­£åé¢ï¼Œæ‰€ä»¥ä½ å¯ä»¥å‚è€ƒä»¤ç‰Œæ¡¶ç®—æ³•çš„å®ç°æ¥å®ç°æ¼æ¡¶ç®—æ³•ã€‚</p><p>ä¸Šé¢æˆ‘ä»¬ä»‹ç»äº†Guavaæ˜¯å¦‚ä½•å®ç°ä»¤ç‰Œæ¡¶ç®—æ³•çš„ï¼Œæˆ‘ä»¬çš„ç¤ºä¾‹ä»£ç æ˜¯å¯¹Guava RateLimiterçš„ç®€åŒ–ï¼ŒGuava RateLimiteræ‰©å±•äº†æ ‡å‡†çš„ä»¤ç‰Œæ¡¶ç®—æ³•ï¼Œæ¯”å¦‚è¿˜èƒ½æ”¯æŒé¢„çƒ­åŠŸèƒ½ã€‚å¯¹äºæŒ‰éœ€åŠ è½½çš„ç¼“å­˜æ¥è¯´ï¼Œé¢„çƒ­åç¼“å­˜èƒ½æ”¯æŒ5ä¸‡TPSçš„å¹¶å‘ï¼Œä½†æ˜¯åœ¨é¢„çƒ­å‰5ä¸‡TPSçš„å¹¶å‘ç›´æ¥å°±æŠŠç¼“å­˜å‡»å®äº†ï¼Œæ‰€ä»¥å¦‚æœéœ€è¦ç»™è¯¥ç¼“å­˜é™æµï¼Œé™æµå™¨ä¹Ÿéœ€è¦æ”¯æŒé¢„çƒ­åŠŸèƒ½ï¼Œåœ¨åˆå§‹é˜¶æ®µï¼Œé™åˆ¶çš„æµé€Ÿ r å¾ˆå°ï¼Œä½†æ˜¯åŠ¨æ€å¢é•¿çš„ã€‚é¢„çƒ­åŠŸèƒ½çš„å®ç°éå¸¸å¤æ‚ï¼ŒGuavaæ„å»ºäº†ä¸€ä¸ªç§¯åˆ†å‡½æ•°æ¥è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œå¦‚æœä½ æ„Ÿå…´è¶£ï¼Œå¯ä»¥ç»§ç»­æ·±å…¥ç ”ç©¶ã€‚</p><p>æ¬¢è¿åœ¨ç•™è¨€åŒºä¸æˆ‘åˆ†äº«ä½ çš„æƒ³æ³•ï¼Œä¹Ÿæ¬¢è¿ä½ åœ¨ç•™è¨€åŒºè®°å½•ä½ çš„æ€è€ƒè¿‡ç¨‹ã€‚æ„Ÿè°¢é˜…è¯»ï¼Œå¦‚æœä½ è§‰å¾—è¿™ç¯‡æ–‡ç« å¯¹ä½ æœ‰å¸®åŠ©çš„è¯ï¼Œä¹Ÿæ¬¢è¿æŠŠå®ƒåˆ†äº«ç»™æ›´å¤šçš„æœ‹å‹ã€‚</p><p><img src="https://static001.geekbang.org/resource/image/cf/aa/cf393cd748a4f0e6451807c4b61843aa.jpg" alt=""></p><h2>ç²¾é€‰ç•™è¨€ï¼š</h2>
        <ul>
        
<li>
    <div>
        <div style="color: #888;font-size:15.25px;font-weight:400;line-height:1.2">
            å¯†ç 123456  2019-05-25 10:22:57
        </div>
        <div style="color:#353535;font-weight:400;white-space:normal;word-break:break-all;line-height:1.6">
            æ¡¶å®¹é‡ä¸º1çš„æ—¶å€™ï¼Œæˆ‘èƒ½ç†è§£ã€‚ä½†æ˜¯æ¡¶å®¹é‡ä¸ºå¤šä¸ªçš„æ—¶å€™ï¼Œå°±ä¸ç†è§£äº†ï¼Œæ¯”å¦‚<br>&#47;&#47; æ–°äº§ç”Ÿçš„ä»¤ç‰Œæ•°<br>      long newPermits=(now-next)&#47;interval;<br>è¿™å¥ï¼Œä¸åº”è¯¥1ç§’ç”Ÿæˆæ¡¶çš„æ€»å®¹é‡å—ï¼Ÿå‡è®¾nowä¸º2ï¼Œnextä¸º1ã€‚intervalä¹Ÿä¸º1ã€‚é‚£ä¹ˆä¸€ä¸ªå‘¨æœŸä¹Ÿå°±äº§ç”Ÿä¸€ä¸ªä»¤ç‰Œå•Šï¼Ÿ 
        </div>
        
    </div>
</li>
            
<br/>

<li>
    <div>
        <div style="color: #888;font-size:15.25px;font-weight:400;line-height:1.2">
            é‡è§é˜³å…‰  2019-05-25 09:00:12
        </div>
        <div style="color:#353535;font-weight:400;white-space:normal;word-break:break-all;line-height:1.6">
            RateLimiterè¿™ä¸ªé™æµå™¨å’ŒjucåŒ…çš„ä¿¡å·é‡æœ‰å•¥åŒºåˆ«ï¼Ÿ 
        </div>
        
    </div>
</li>
            
<br/>

<li>
    <div>
        <div style="color: #888;font-size:15.25px;font-weight:400;line-height:1.2">
            undifined  2019-05-25 08:58:35
        </div>
        <div style="color:#353535;font-weight:400;white-space:normal;word-break:break-all;line-height:1.6">
            å¯¹äºè¿™ä¸ªè¯·æ±‚ä»¤ç‰Œçš„çº¿ç¨‹è€Œè¨€ï¼Œå¾ˆæ˜¾ç„¶éœ€è¦ç­‰å¾… 1 ç§’ï¼Œå› ä¸º 1 ç§’ä»¥åï¼ˆç¬¬ 3 ç§’ï¼‰å®ƒå°±èƒ½æ‹¿åˆ°ä»¤ç‰Œäº†ã€‚æ­¤æ—¶éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä¸‹ä¸€ä¸ªä»¤ç‰Œå‘æ”¾çš„æ—¶é—´ä¹Ÿè¦å¢åŠ  1 ç§’ï¼Œä¸ºä»€ä¹ˆå‘¢ï¼Ÿå› ä¸ºç¬¬ 3 ç§’å‘æ”¾çš„ä»¤ç‰Œå·²ç»è¢«çº¿ç¨‹ T1 é¢„å äº†ã€‚å¤„ç†ä¹‹åå¦‚ä¸‹å›¾æ‰€ç¤ºã€‚<br><br>â€œä¸‹ä¸€ä¸ªä»¤ç‰Œå‘æ”¾çš„æ—¶é—´ä¹Ÿè¦å¢åŠ  1 ç§’â€è¿™å¥è¯æ²¡æ‡‚ï¼Œä¸‹ä¸€ä¸ªä»¤ç‰Œæ˜¯æŒ‡å¯ä»¥ä¸‹ä¸€æ¬¡è¯·æ±‚å¯ä»¥æ‹¿åˆ°çš„æœ‰æ•ˆä»¤ç‰Œå—ï¼›æˆ‘çš„ç†è§£æ˜¯æ¯ç§’éƒ½äº§ç”Ÿä»¤ç‰Œï¼Œç¬¬ 3 ç§’çš„å·²ç»è¢«ä¸Šä¸€ä¸ªè¯·æ±‚å ç”¨äº†ï¼Œæ‰€ä»¥ä¸‹ä¸€ä¸ªè¯·æ±‚å¾—ç­‰åˆ°ç¬¬ 4 ç§’äº§ç”Ÿæœ‰æ•ˆçš„ä»¤ç‰Œæ‰å¯ä»¥ï¼Œè€Œä¸æ˜¯ç¬¬ 4 ç§’ä¸äº§ç”Ÿä»¤ç‰Œï¼›è¿™æ ·ç†è§£å¯¹å—ï¼Œè°¢è°¢è€å¸ˆ 
        </div>
        
    </div>
</li>
            
<br/>

<li>
    <div>
        <div style="color: #888;font-size:15.25px;font-weight:400;line-height:1.2">
            ææœªæ¥  2019-05-25 08:34:29
        </div>
        <div style="color:#353535;font-weight:400;white-space:normal;word-break:break-all;line-height:1.6">
            å½“æˆ‘çœ‹åˆ°ç§¯åˆ†å‡½æ•°æ—¶ï¼Œæ„Ÿè§‰æ•°å­¦ä¹Ÿè¦å¥½å¥½å­¦ä¹ äº†ğŸ˜‚ 
        </div>
        
    </div>
</li>
            
<br/>

<li>
    <div>
        <div style="color: #888;font-size:15.25px;font-weight:400;line-height:1.2">
            é«˜æº  2019-05-25 08:31:32
        </div>
        <div style="color:#353535;font-weight:400;white-space:normal;word-break:break-all;line-height:1.6">
            è¿˜æœ‰å°±æ˜¯è€å¸ˆæˆ‘é—®ä¸€ä¸‹å› ä¸ºæˆ‘ä¸æ˜¯åœ¨äº’è”ç½‘å…¬å¸å·¥ä½œæ¥è§¦é«˜å¹¶å‘åœºæ™¯å°‘ï¼Œæˆ‘åˆå–œæ¬¢å­¦ä¹ ç ”ç©¶æé«˜è‡ªå·±ï¼Œæ˜¯ä¸æ˜¯å¾—å¤šçœ‹å¤šç»ƒï¼Œå®æˆ˜ 
        </div>
        
    </div>
</li>
            
<br/>

<li>
    <div>
        <div style="color: #888;font-size:15.25px;font-weight:400;line-height:1.2">
            é«˜æº  2019-05-25 08:19:51
        </div>
        <div style="color:#353535;font-weight:400;white-space:normal;word-break:break-all;line-height:1.6">
            è€å¸ˆæƒ³è¯·æ•™ä¸ªå®é™…é—®é¢˜ï¼Œå‡è®¾å•æœºåšæœåŠ¡å™¨ç«¯winå’Œä¸‹é¢Linuxåº”ç”¨ç¨‹åºå®æ—¶socketé€šä¿¡ï¼Œæ¯ä¸ªæ¶ˆæ¯äº¤äº’æ—¶é—´å¤§æ¦‚10æ¯«ç§’ï¼Œæˆ‘ç°åœ¨æƒ³æé€Ÿï¼Œæƒ³æŠŠäº¤äº’æ—¶é—´å˜æˆ0.1æ¯«ç§’ï¼Œæœ‰å•¥æ–¹æ³•è§£å†³æ­¤é—®é¢˜ï¼ŒæœåŠ¡å™¨ç«¯æ‰¿è½½ä¸šåŠ¡å¤„ç†é€»è¾‘å’Œæ•°æ®åº“è¯»å†™æ“ä½œï¼Œè°¢è°¢ï¼Œæˆ‘ç°åœ¨ä¸æ¸…æ¥šè¿™ä¸ªé—®é¢˜å¦‚ä½•è§£å†³ï¼Œæˆ‘æƒ³æ³•æ˜¯æ›´æ¢ç½‘ç»œæ¡†æ¶ï¼Œä¾‹å¦‚æ¢æˆnettyæ¡†æ¶ 
        </div>
        
    </div>
</li>
            </ul>
</div>
</body>
</html>